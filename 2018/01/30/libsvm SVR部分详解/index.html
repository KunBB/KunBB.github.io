<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">

<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">


  <script>
  (function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0f81ff2f.js","daovoice")
  daovoice('init', {
      app_id: "e77a7f88"
    });
  daovoice('update');
  </script>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  

  
    
      
    

    
  

  
    
      
    

    
  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Monda:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Lobster Two:300,300italic,400,400italic,700,700italic|PT Mono:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Machine learning," />








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.2" />






<meta name="description" content="LibSVM是是台湾林智仁(Chih-Jen Lin)教授2001年开发的一套支持向量机的库，可以很方便的对数据做分类或回归。由于LibSVM程序小，运用灵活，输入参数少，并且是开源的，易于扩展，因此成为目前国内应用最多的SVM的库，同时sklearn.svm也是使用的该库。 网络上对于LibSVM源码的讲解有很多，但个人感觉绝大多数讲解的不够清晰，很多都是贴个理论公式图片再粘段代码就一带而过。并">
<meta name="keywords" content="Machine learning">
<meta property="og:type" content="article">
<meta property="og:title" content="LibSVM支持向量回归详解">
<meta property="og:url" content="http://yoursite.com/2018/01/30/libsvm SVR部分详解/index.html">
<meta property="og:site_name" content="KunBB&#39;s blog">
<meta property="og:description" content="LibSVM是是台湾林智仁(Chih-Jen Lin)教授2001年开发的一套支持向量机的库，可以很方便的对数据做分类或回归。由于LibSVM程序小，运用灵活，输入参数少，并且是开源的，易于扩展，因此成为目前国内应用最多的SVM的库，同时sklearn.svm也是使用的该库。 网络上对于LibSVM源码的讲解有很多，但个人感觉绝大多数讲解的不够清晰，很多都是贴个理论公式图片再粘段代码就一带而过。并">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/1.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/2.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/3.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_4.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_5.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_6.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_7.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_8.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_9.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_10.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_11.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_12.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_13.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_14.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_15.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_16.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_17.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_18.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_19.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_20.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/21.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/22.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/23.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/24.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/27.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/25.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/26.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/28.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/29.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/30.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/31.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/32.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/33.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/34.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/35.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/36.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/37.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/38.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/39.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/40.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/41.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/42.jpg?raw=true">
<meta property="og:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/43.jpg?raw=true">
<meta property="og:updated_time" content="2018-09-17T02:34:55.888Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="LibSVM支持向量回归详解">
<meta name="twitter:description" content="LibSVM是是台湾林智仁(Chih-Jen Lin)教授2001年开发的一套支持向量机的库，可以很方便的对数据做分类或回归。由于LibSVM程序小，运用灵活，输入参数少，并且是开源的，易于扩展，因此成为目前国内应用最多的SVM的库，同时sklearn.svm也是使用的该库。 网络上对于LibSVM源码的讲解有很多，但个人感觉绝大多数讲解的不够清晰，很多都是贴个理论公式图片再粘段代码就一带而过。并">
<meta name="twitter:image" content="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/1.jpg?raw=true">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.2',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/01/30/libsvm SVR部分详解/"/>





  <title>LibSVM支持向量回归详解 | KunBB's blog</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?d76fd55ad2c6a913abb69c04b4c9aadf";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->




</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">KunBB's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">The only time you should ever look back is to see how far you've come.</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
			
		  
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="Searching..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/01/30/libsvm SVR部分详解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yunkun Xu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1505221430290&amp;di=5d6a88d013890d4f520618b024b4aaed&amp;imgtype=0&amp;src=http%3A%2F%2Fimg3.duitang.com%2Fuploads%2Fitem%2F201601%2F03%2F20160103085338_eyBCL.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="KunBB's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">LibSVM支持向量回归详解</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-01-30T10:10:00+08:00">
                2018-01-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SVM/" itemprop="url" rel="index">
                    <span itemprop="name">SVM</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          
             <span id="/2018/01/30/libsvm SVR部分详解/" class="leancloud_visitors" data-flag-title="LibSVM支持向量回归详解">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Heat&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
				 <span>℃</span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  8,392
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  43
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>LibSVM是是台湾林智仁(Chih-Jen Lin)教授2001年开发的一套支持向量机的库，可以很方便的对数据做分类或回归。由于LibSVM程序小，运用灵活，输入参数少，并且是开源的，易于扩展，因此成为目前国内应用最多的SVM的库，同时sklearn.svm也是使用的该库。</p>
<p>网络上对于LibSVM源码的讲解有很多，但个人感觉绝大多数讲解的不够清晰，很多都是贴个理论公式图片再粘段代码就一带而过。并且网络上基本都是对SVC的讲解，SVR部分几乎没有提及（虽然SVR只是SVC的扩展）。因此本篇博文将系统地讲解LibSVM中SVR训练与预测部分的源码（想学习SVC的同学同样适用）。<br><a id="more"></a></p>
<hr>
<h1 id="LibSVM整体流程"><a href="#LibSVM整体流程" class="headerlink" title="LibSVM整体流程"></a>LibSVM整体流程</h1><h2 id="train："><a href="#train：" class="headerlink" title="train："></a>train：</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//根据svm_type的不同进行初始化</span></div><div class="line">svm_train()</div><div class="line">    <span class="comment">//根据svm_type的不同调用不同的分类回归训练函数</span></div><div class="line">    svm_train_one()</div><div class="line">        <span class="comment">//针对epsilon-SVR这一类型进行模型参数初始化</span></div><div class="line">        solve_epsilon_svr()</div><div class="line">            <span class="comment">//使用SMO算法求解对偶问题（二次优化问题）</span></div><div class="line">            Solver::Solve()</div><div class="line">                    <span class="comment">//每隔若干次迭代进行一次shrinking，对样本集进行缩减降低计算成本</span></div><div class="line">                    Solver::do_shrinking()</div><div class="line">                    <span class="comment">//若满足停止条件则进行梯度重建并跳出循环</span></div><div class="line">                    Solver::reconstruct_gradient()</div><div class="line">                    <span class="comment">//选择出当前最大违反对i,j</span></div><div class="line">                    Solver::select_working_set()</div><div class="line">                <span class="comment">//计算参数优化后的rho</span></div><div class="line">                Solver::caculate_rho()</div><div class="line">            <span class="comment">//得到优化后的alpha和SolutionInfo对象si</span></div><div class="line">        <span class="comment">//得到优化后的alpha和SolutionInfo对象si</span></div><div class="line">    <span class="comment">//得到decision_function对象f</span></div><div class="line"><span class="comment">//得到svm_model对象model</span></div></pre></td></tr></table></figure>
<h2 id="predict"><a href="#predict" class="headerlink" title="predict"></a>predict</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//根据svm_type的不同开辟dec_value空间</span></div><div class="line">svm_predict()</div><div class="line">    <span class="comment">//根据svm_type的不同调用k_function函数</span></div><div class="line">    svm_predict_values()</div><div class="line">        <span class="comment">//根据kernel_type的不同计算k(i,j)</span></div><div class="line">        Kernel::k_function()</div><div class="line">        <span class="comment">//得到k(x_train[i],x_test[j])</span></div><div class="line">    <span class="comment">//得到预测值y_pre[j]</span></div><div class="line"><span class="comment">//得到预测值y_pre[j]</span></div></pre></td></tr></table></figure>
<hr>
<h1 id="svm-h文件解析"><a href="#svm-h文件解析" class="headerlink" title="svm.h文件解析"></a>svm.h文件解析</h1><h2 id="svm-node"><a href="#svm-node" class="headerlink" title="svm_node"></a>svm_node</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//存储一个样本（假设为样本i）的一个特征</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">svm_node</span>&#123;</span></div><div class="line">    <span class="keyword">int</span> index;   <span class="comment">//样本i的特征索引值，最后一个为-1</span></div><div class="line">    <span class="keyword">double</span> value;   <span class="comment">//样本i第index个特征的值，最后一个为NULL</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>如：x[i]={0.23,1.2,3.5,1.5}<br>则需使用五个svm_node来表示x[i]，具体映射如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">index</th>
<th style="text-align:center">0</th>
<th style="text-align:center">1</th>
<th style="text-align:center">2</th>
<th style="text-align:center">3</th>
<th style="text-align:center">-1</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">value</td>
<td style="text-align:center">0.23</td>
<td style="text-align:center">1.2</td>
<td style="text-align:center">3.5</td>
<td style="text-align:center">1.5</td>
<td style="text-align:center">NULL</td>
</tr>
</tbody>
</table>
</div>
<h2 id="svm-problem"><a href="#svm-problem" class="headerlink" title="svm_problem"></a>svm_problem</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//存储参加运算的所有样本数据（训练集）</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">svm_problem</span>&#123;</span></div><div class="line">        <span class="keyword">int</span> l;    <span class="comment">//样本总数</span></div><div class="line">        <span class="keyword">double</span> *y;    <span class="comment">//样本输出值（所属类别）</span></div><div class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">svm_node</span> **<span class="title">x</span>;</span>    <span class="comment">//样本输入值</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>下图中最右边的长条格同上表，存储了三维数据。</p>
<p><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/1.jpg?raw=true" alt="Loading..."></p>
<p><strong>svm_problem中的y与类Solver中的y并不完全一样!!!</strong>对于一般SVC而言可以看出一样的，其值为-1与+1，对于多分类而言svm_problem.y[i]可以是1、2、3等，而多类计算其实是二分类的组合，因此在二分类中y[i]依然等于+1与-1.更特殊的，在SVR中，svm_problem的y[i]等于其目标值，如：11.234、56.24、5.23等，在计算时svm_problem.y[i]整合到了Solver.p[i]与Solver.p[i+svm_problem.l]中（具体的问题后续章节再详细解释），而在Solver.y[i]依然为+1和-1.</p>
<h2 id="svm-parameter"><a href="#svm-parameter" class="headerlink" title="svm_parameter"></a>svm_parameter</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//svm_type和svm_type可能取值</span></div><div class="line"><span class="keyword">enum</span> &#123; C\_SVC, NU\_SVC, ONE\_CLASS, EPSILON\_SVR, NU\_SVR &#125;;<span class="comment">/* svm_type */</span></div><div class="line"><span class="keyword">enum</span> &#123; LINEAR, POLY, RBF, SIGMOID &#125;; <span class="comment">/* kernel_type */</span></div><div class="line"></div><div class="line"><span class="comment">//svm模型训练参数</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">svm_parameter</span></span></div><div class="line"><span class="class">    &#123;</span></div><div class="line">        <span class="keyword">int</span> svm_type;</div><div class="line">        <span class="keyword">int</span> kernel_type;</div><div class="line">        <span class="keyword">int</span> degree; <span class="comment">/* for poly */</span></div><div class="line">        <span class="keyword">double</span> gamma;   <span class="comment">/* for poly/rbf/sigmoid */</span></div><div class="line">        <span class="keyword">double</span> coef0;   <span class="comment">/* for poly/sigmoid */</span></div><div class="line"></div><div class="line">        <span class="comment">/* these are for training only */</span></div><div class="line">        <span class="keyword">double</span> cache_size; <span class="comment">/* in MB */</span></div><div class="line">        <span class="keyword">double</span> eps; <span class="comment">/* stopping criteria */</span></div><div class="line">        <span class="keyword">double</span> C;   <span class="comment">/* for C_SVC, EPSILON_SVR and NU_SVR */</span></div><div class="line">        <span class="keyword">int</span> nr_weight;      <span class="comment">/* for C_SVC */</span></div><div class="line">        <span class="keyword">int</span> *weight_label;  <span class="comment">/* for C_SVC */</span></div><div class="line">        <span class="keyword">double</span>* weight;     <span class="comment">/* for C_SVC */</span></div><div class="line">        <span class="keyword">double</span> nu;  <span class="comment">/* for NU_SVC, ONE_CLASS, and NU_SVR */</span></div><div class="line">        <span class="keyword">double</span> p;   <span class="comment">/* for EPSILON_SVR */</span></div><div class="line">        <span class="keyword">int</span> shrinking;  <span class="comment">/* use the shrinking heuristics */</span></div><div class="line">        <span class="keyword">int</span> probability; <span class="comment">/* do probability estimates */</span></div><div class="line">    &#125;;</div></pre></td></tr></table></figure>
<p>LibSVM中的核函数如下：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/2.jpg?raw=true" alt="Loading..."></p>
<p>各参数解释如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Parameter</th>
<th style="text-align:center">Interpretation</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">degree</td>
<td style="text-align:center">2式中的d</td>
</tr>
<tr>
<td style="text-align:center">gamma</td>
<td style="text-align:center">2,3,4式中的gamma</td>
</tr>
<tr>
<td style="text-align:center">coef0</td>
<td style="text-align:center">2,4式中的r</td>
</tr>
<tr>
<td style="text-align:center">cache_size</td>
<td style="text-align:center">单位MB，训练所需内存，LibSVM2.5默认4M</td>
</tr>
<tr>
<td style="text-align:center">eps</td>
<td style="text-align:center">停止条件需满足的最大误差值(文献[2]中式3.9)</td>
</tr>
<tr>
<td style="text-align:center">C</td>
<td style="text-align:center">惩罚因子，越大模型过拟合越严重</td>
</tr>
<tr>
<td style="text-align:center">nr_weight</td>
<td style="text-align:center">权重的数目,目前在实例代码中只有两个值，一个是默认0，另外一个是svm_binary_svc_probability函数中使用数值2</td>
</tr>
<tr>
<td style="text-align:center">*weight_label</td>
<td style="text-align:center">权重，元素个数由nr_weight决定.</td>
</tr>
<tr>
<td style="text-align:center">nu</td>
<td style="text-align:center">NU_SVC,ONE_CLASS,NU_SVR中的nu</td>
</tr>
<tr>
<td style="text-align:center">p</td>
<td style="text-align:center">SVR中的间隔带epsilon</td>
</tr>
<tr>
<td style="text-align:center">shrinking</td>
<td style="text-align:center">指明训练过程是否使用压缩</td>
</tr>
<tr>
<td style="text-align:center">probability</td>
<td style="text-align:center">指明是否做概率估计</td>
</tr>
</tbody>
</table>
</div>
<h2 id="svm-model"><a href="#svm-model" class="headerlink" title="svm_model"></a>svm_model</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//保存训练后的模型参数</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">svm_model</span>&#123;</span></div><div class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">svm_parameter</span> <span class="title">param</span>;</span> <span class="comment">/* parameter */</span></div><div class="line">        <span class="keyword">int</span> nr_class;       <span class="comment">/* number of classes, = 2 in regression/one class svm */</span></div><div class="line">        <span class="keyword">int</span> l;          <span class="comment">/* total #SV */</span></div><div class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">svm_node</span> **<span class="title">SV</span>;</span>       <span class="comment">/* SVs (SV[l]) */</span></div><div class="line">        <span class="keyword">double</span> **sv_coef;   <span class="comment">/* coefficients for SVs in decision functions (sv_coef[k-1][l]) */</span></div><div class="line">        <span class="keyword">double</span> *rho;        <span class="comment">/* constants in decision functions (rho[k*(k-1)/2]) */</span></div><div class="line">        <span class="keyword">double</span> *probA;      <span class="comment">/* pariwise probability information */</span></div><div class="line">        <span class="keyword">double</span> *probB;</div><div class="line">        <span class="keyword">int</span> *sv_indices;        <span class="comment">/* sv_indices[0,...,nSV-1] are values in [1,...,num_traning_data] to indicate SVs in the training set */</span></div><div class="line"></div><div class="line">                                <span class="comment">/* for classification only */</span></div><div class="line"></div><div class="line">        <span class="keyword">int</span> *label;     <span class="comment">/* label of each class (label[k]) */</span></div><div class="line">        <span class="keyword">int</span> *nSV;       <span class="comment">/* number of SVs for each class (nSV[k]) */</span></div><div class="line">                        <span class="comment">/* nSV[0] + nSV[1] + ... + nSV[k-1] = l */</span></div><div class="line">                        <span class="comment">/* XXX */</span></div><div class="line">        <span class="keyword">int</span> free_sv;        <span class="comment">/* 1 if svm_model is created by svm_load_model*/</span></div><div class="line">                            <span class="comment">/* 0 if svm_model is created by svm_train */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>各参数解释如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Parameter</th>
<th style="text-align:center">Interpretation</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">param</td>
<td style="text-align:center">训练参数</td>
</tr>
<tr>
<td style="text-align:center">nr_class</td>
<td style="text-align:center">类别数</td>
</tr>
<tr>
<td style="text-align:center">l</td>
<td style="text-align:center">支持向量数</td>
</tr>
<tr>
<td style="text-align:center">**SV</td>
<td style="text-align:center">作为支持向量的样本集</td>
</tr>
<tr>
<td style="text-align:center">**sv_coef</td>
<td style="text-align:center">支持向量系数alpha</td>
</tr>
<tr>
<td style="text-align:center">*rho</td>
<td style="text-align:center">判别函数中的b</td>
</tr>
<tr>
<td style="text-align:center">*proA</td>
<td style="text-align:center">成对概率信息</td>
</tr>
<tr>
<td style="text-align:center">*proB</td>
<td style="text-align:center">成对概率信息</td>
</tr>
<tr>
<td style="text-align:center">*sv_indices</td>
<td style="text-align:center">记录支持向量在训练数据中的index</td>
</tr>
<tr>
<td style="text-align:center">*label</td>
<td style="text-align:center">各类的标签</td>
</tr>
<tr>
<td style="text-align:center">*nSV</td>
<td style="text-align:center">各类的支持向量数</td>
</tr>
<tr>
<td style="text-align:center">free_SV</td>
<td style="text-align:center">若model由svm_load_model函数生成则为1，若为svm_train生成则为0</td>
</tr>
</tbody>
</table>
</div>
<hr>
<h1 id="svm-cpp文件解析"><a href="#svm-cpp文件解析" class="headerlink" title="svm.cpp文件解析"></a>svm.cpp文件解析</h1><p>下图为svm.cpp中的类继承和组合情况（实现表示继承关系，虚线表示组合关系）：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/3.jpg?raw=true" alt="Loading..."><br>Cache类主要负责运算所涉及的内存的管理，包括申请、释放等。本篇博文主要讲解SVM求解过程，对于Cache类将不予解析。</p>
<h2 id="Kernel类"><a href="#Kernel类" class="headerlink" title="Kernel类"></a>Kernel类</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Kernel</span> :</span> <span class="keyword">public</span> QMatrix &#123;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    Kernel(<span class="keyword">int</span> l, svm_node * <span class="keyword">const</span> * x, <span class="keyword">const</span> svm_parameter&amp; param);</div><div class="line">    <span class="keyword">virtual</span> ~Kernel();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">double</span> <span class="title">k_function</span><span class="params">(<span class="keyword">const</span> svm_node *x, <span class="keyword">const</span> svm_node *y,</span></span></div><div class="line"><span class="function"><span class="params">        <span class="keyword">const</span> svm_parameter&amp; param)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">virtual</span> Qfloat *<span class="title">get_Q</span><span class="params">(<span class="keyword">int</span> column, <span class="keyword">int</span> len)</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</div><div class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">double</span> *<span class="title">get_QD</span><span class="params">()</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</div><div class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">swap_index</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> <span class="keyword">const</span> <span class="comment">// no so const...</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        swap(x[i], x[j]);</div><div class="line">        <span class="keyword">if</span> (x_square) swap(x_square[i], x_square[j]);</div><div class="line">    &#125;</div><div class="line"><span class="keyword">protected</span>:</div><div class="line"></div><div class="line">    <span class="keyword">double</span> (Kernel::*kernel_function)(<span class="keyword">int</span> i, <span class="keyword">int</span> j) <span class="keyword">const</span>;</div><div class="line"></div><div class="line"><span class="keyword">private</span>:</div><div class="line">    <span class="keyword">const</span> svm_node **x;</div><div class="line">    <span class="keyword">double</span> *x_square;</div><div class="line"></div><div class="line">    <span class="comment">// svm_parameter</span></div><div class="line">    <span class="keyword">const</span> <span class="keyword">int</span> kernel_type;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">int</span> degree;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">double</span> gamma;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">double</span> coef0;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">double</span> <span class="title">dot</span><span class="params">(<span class="keyword">const</span> svm_node *px, <span class="keyword">const</span> svm_node *py)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">double</span> <span class="title">kernel_linear</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> <span class="keyword">const</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> dot(x[i], x[j]);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">double</span> <span class="title">kernel_poly</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> <span class="keyword">const</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> powi(gamma*dot(x[i], x[j]) + coef0, degree);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">double</span> <span class="title">kernel_rbf</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> <span class="keyword">const</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="built_in">exp</span>(-gamma * (x_square[i] + x_square[j] - <span class="number">2</span> * dot(x[i], x[j])));</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">double</span> <span class="title">kernel_sigmoid</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> <span class="keyword">const</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="built_in">tanh</span>(gamma*dot(x[i], x[j]) + coef0);</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">double</span> <span class="title">kernel_precomputed</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> <span class="keyword">const</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> x[i][(<span class="keyword">int</span>)(x[j][<span class="number">0</span>].value)].value;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="成员变量"><a href="#成员变量" class="headerlink" title="成员变量"></a>成员变量</h3><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Parameter</th>
<th style="text-align:center">Interpretation</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">svm_node **x</td>
<td style="text-align:center">训练样本数据</td>
</tr>
<tr>
<td style="text-align:center">*x_square</td>
<td style="text-align:center">x[i]^T*x[i]，使用RBF核会用到</td>
</tr>
<tr>
<td style="text-align:center">kernel_type</td>
<td style="text-align:center">核函数类型</td>
</tr>
<tr>
<td style="text-align:center">degree</td>
<td style="text-align:center">svm_parameter</td>
</tr>
<tr>
<td style="text-align:center">gamma</td>
<td style="text-align:center">svm_parameter</td>
</tr>
<tr>
<td style="text-align:center">coef0</td>
<td style="text-align:center">svm_parameter</td>
</tr>
</tbody>
</table>
</div>
<h3 id="成员函数"><a href="#成员函数" class="headerlink" title="成员函数"></a>成员函数</h3><h4 id="Kernel-int-l-svm-node-const-x-const-svm-parameter-amp-param"><a href="#Kernel-int-l-svm-node-const-x-const-svm-parameter-amp-param" class="headerlink" title="Kernel(int l, svm_node * const * x, const svm_parameter&amp; param);"></a>Kernel(int l, svm_node * const * x, const svm_parameter&amp; param);</h4><p>构造函数。初始化类中的部分常量、指定核函数、克隆样本数据。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">Kernel::Kernel(<span class="keyword">int</span> l, svm_node * <span class="keyword">const</span> * x_, <span class="keyword">const</span> svm_parameter&amp; param)</div><div class="line">    :kernel_type(param.kernel_type), degree(param.degree),</div><div class="line">    gamma(param.gamma), coef0(param.coef0)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">switch</span> (kernel_type)    <span class="comment">//根据kernel_type的不同定义相应的函数kernel_function()</span></div><div class="line">    &#123;</div><div class="line">    <span class="keyword">case</span> LINEAR:</div><div class="line">        kernel_function = &amp;Kernel::kernel_linear;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> POLY:</div><div class="line">        kernel_function = &amp;Kernel::kernel_poly;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> RBF:</div><div class="line">        kernel_function = &amp;Kernel::kernel_rbf;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> SIGMOID:</div><div class="line">        kernel_function = &amp;Kernel::kernel_sigmoid;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> PRECOMPUTED:</div><div class="line">        kernel_function = &amp;Kernel::kernel_precomputed;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    clone(x, x_, l);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (kernel_type == RBF)    <span class="comment">//如果使用RBF 核函数，则计算x_sqare[i]，即x[i]^T*x[i]</span></div><div class="line">    &#123;</div><div class="line">        x_square = <span class="keyword">new</span> <span class="keyword">double</span>[l];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt;l; i++)</div><div class="line">            x_square[i] = dot(x[i], x[i]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        x_square = <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="static-double-dot-const-svm-node-px-const-svm-node-py"><a href="#static-double-dot-const-svm-node-px-const-svm-node-py" class="headerlink" title="static double dot(const svm_node *px, const svm_node *py);"></a>static double dot(const svm_node *px, const svm_node *py);</h4><p>点乘函数，点乘两个样本数据，按svm_node 中index (一般为特征)进行运算，一般来说，index为1，2，…直到-1。返回点乘总和。例如：x1={1,2,3} ,x2={4,5,6}总和为sum=1*4+2*5+3*6;在svm_node[3]中存储index=-1时，停止计算。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">double</span> Kernel::dot(<span class="keyword">const</span> svm_node *px, <span class="keyword">const</span> svm_node *py)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">double</span> sum = <span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span> (px-&gt;index != <span class="number">-1</span> &amp;&amp; py-&gt;index != <span class="number">-1</span>)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (px-&gt;index == py-&gt;index)</div><div class="line">        &#123;</div><div class="line">            sum += px-&gt;value * py-&gt;value;</div><div class="line">            ++px;</div><div class="line">            ++py;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (px-&gt;index &gt; py-&gt;index)</div><div class="line">                ++py;</div><div class="line">            <span class="keyword">else</span></div><div class="line">                ++px;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> sum;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="static-double-k-function-const-svm-node-x-const-svm-node-y-const-svm-parameter-amp-param"><a href="#static-double-k-function-const-svm-node-x-const-svm-node-y-const-svm-parameter-amp-param" class="headerlink" title="static double k_function(const svm_node *x, const svm_node *y, const svm_parameter&amp; param);"></a>static double k_function(const svm_node *x, const svm_node *y, const svm_parameter&amp; param);</h4><p>功能类似kernel_function,不过kerel_function用于训练，k_function用于预测。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">double</span> Kernel::k_function(<span class="keyword">const</span> svm_node *x, <span class="keyword">const</span> svm_node *y,</div><div class="line">    <span class="keyword">const</span> svm_parameter&amp; param)    <span class="comment">//输入数据为两个数据样本，其中一个为训练样本一个为测试样本</span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">switch</span> (param.kernel_type)</div><div class="line">    &#123;</div><div class="line">    <span class="keyword">case</span> LINEAR:</div><div class="line">        <span class="keyword">return</span> dot(x, y);</div><div class="line">    <span class="keyword">case</span> POLY:</div><div class="line">        <span class="keyword">return</span> powi(param.gamma*dot(x, y) + param.coef0, param.degree);</div><div class="line">    <span class="keyword">case</span> RBF:</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">double</span> sum = <span class="number">0</span>;</div><div class="line">        <span class="keyword">while</span> (x-&gt;index != <span class="number">-1</span> &amp;&amp; y-&gt;index != <span class="number">-1</span>)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (x-&gt;index == y-&gt;index)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">double</span> d = x-&gt;value - y-&gt;value;</div><div class="line">                sum += d * d;</div><div class="line">                ++x;</div><div class="line">                ++y;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span></div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span> (x-&gt;index &gt; y-&gt;index)</div><div class="line">                &#123;</div><div class="line">                    sum += y-&gt;value * y-&gt;value;</div><div class="line">                    ++y;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span></div><div class="line">                &#123;</div><div class="line">                    sum += x-&gt;value * x-&gt;value;</div><div class="line">                    ++x;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">while</span> (x-&gt;index != <span class="number">-1</span>)</div><div class="line">        &#123;</div><div class="line">            sum += x-&gt;value * x-&gt;value;</div><div class="line">            ++x;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">while</span> (y-&gt;index != <span class="number">-1</span>)</div><div class="line">        &#123;</div><div class="line">            sum += y-&gt;value * y-&gt;value;</div><div class="line">            ++y;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="built_in">exp</span>(-param.gamma*sum);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">case</span> SIGMOID:</div><div class="line">        <span class="keyword">return</span> <span class="built_in">tanh</span>(param.gamma*dot(x, y) + param.coef0);</div><div class="line">    <span class="keyword">case</span> PRECOMPUTED:  <span class="comment">//x: test (validation), y: SV</span></div><div class="line">        <span class="keyword">return</span> x[(<span class="keyword">int</span>)(y-&gt;value)].value;</div><div class="line">    <span class="keyword">default</span>:</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;  <span class="comment">// Unreachable</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中RBF部分很有讲究。因为存储时，0值不保留。如果所有0值都保留，第一个while就可以都做完了；如果第一个while做不完，在x，y中任意一个出现index＝-1，第一个while就停止，剩下的代码中两个while只会有一个工作，该循环直接把剩下的计算做完。</p>
<h4 id="virtual-Qfloat-get-Q-int-column-int-len"><a href="#virtual-Qfloat-get-Q-int-column-int-len" class="headerlink" title="virtual Qfloat *get_Q(int column, int len);"></a>virtual Qfloat *get_Q(int column, int len);</h4><p>纯虚函数，将来在子类中实现(如class SVR_Q)，计算Q值。相当重要的函数。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">virtual</span> Qfloat *<span class="title">get_Q</span><span class="params">(<span class="keyword">int</span> column, <span class="keyword">int</span> len)</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</div></pre></td></tr></table></figure>
<h4 id="virtual-void-swap-index-int-i-int-j"><a href="#virtual-void-swap-index-int-i-int-j" class="headerlink" title="virtual void swap_index(int i, int j);"></a>virtual void swap_index(int i, int j);</h4><p>虚函数，x[i]和x[j]中所存储指针的内容。如果x_square不为空，则交换相应的内容。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">swap_index</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> <span class="keyword">const</span> <span class="comment">// no so const...</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        swap(x[i], x[j]);</div><div class="line">        <span class="keyword">if</span> (x_square) swap(x_square[i], x_square[j]);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h4 id="virtual-double-get-QD"><a href="#virtual-double-get-QD" class="headerlink" title="virtual double *get_QD();"></a>virtual double *get_QD();</h4><p>纯虚函数，将来在子类中实现(如class SVR_Q),计算Q[i,i]值。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">virtual</span> Qfloat *<span class="title">get_Q</span><span class="params">(<span class="keyword">int</span> column, <span class="keyword">int</span> len)</span> <span class="keyword">const</span> </span>= <span class="number">0</span>;</div></pre></td></tr></table></figure>
<h4 id="double-Kernel-kernel-function-int-i-int-j-；"><a href="#double-Kernel-kernel-function-int-i-int-j-；" class="headerlink" title="double (Kernel::*kernel_function)(int i, int j)；"></a>double (Kernel::*kernel_function)(int i, int j)；</h4><p>函数指针，根据相应的核函数类型，来决定所使用的函数。在计算矩阵Q时使用。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">double</span> (Kernel::*kernel_function)(<span class="keyword">int</span> i, <span class="keyword">int</span> j) <span class="keyword">const</span>;</div></pre></td></tr></table></figure>
<h2 id="Solver类"><a href="#Solver类" class="headerlink" title="Solver类"></a>Solver类</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solver</span> &#123;</span></div><div class="line"><span class="keyword">public</span>:</div><div class="line">    Solver() &#123;&#125;;</div><div class="line">    <span class="keyword">virtual</span> ~Solver() &#123;&#125;;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">SolutionInfo</span> &#123;</span></div><div class="line">        <span class="keyword">double</span> obj;</div><div class="line">        <span class="keyword">double</span> rho;</div><div class="line">        <span class="keyword">double</span> upper_bound_p;</div><div class="line">        <span class="keyword">double</span> upper_bound_n;</div><div class="line">        <span class="keyword">double</span> r;   <span class="comment">// for Solver_NU</span></div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Solve</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">const</span> QMatrix&amp; Q, <span class="keyword">const</span> <span class="keyword">double</span> *p_, <span class="keyword">const</span> schar *y_,</span></span></div><div class="line"><span class="function"><span class="params">        <span class="keyword">double</span> *alpha_, <span class="keyword">double</span> Cp, <span class="keyword">double</span> Cn, <span class="keyword">double</span> eps,</span></span></div><div class="line"><span class="function"><span class="params">        SolutionInfo* si, <span class="keyword">int</span> shrinking)</span></span>;</div><div class="line"><span class="keyword">protected</span>:</div><div class="line">    <span class="keyword">int</span> active_size;</div><div class="line">    schar *y;</div><div class="line">    <span class="keyword">double</span> *G;      <span class="comment">// gradient of objective function</span></div><div class="line">    <span class="keyword">enum</span> &#123; LOWER_BOUND, UPPER_BOUND, FREE &#125;;</div><div class="line">    <span class="keyword">char</span> *alpha_status; <span class="comment">// LOWER_BOUND, UPPER_BOUND, FREE</span></div><div class="line">    <span class="keyword">double</span> *alpha;</div><div class="line">    <span class="keyword">const</span> QMatrix *Q;</div><div class="line">    <span class="keyword">const</span> <span class="keyword">double</span> *QD;</div><div class="line">    <span class="keyword">double</span> eps;</div><div class="line">    <span class="keyword">double</span> Cp, Cn;</div><div class="line">    <span class="keyword">double</span> *p;</div><div class="line">    <span class="keyword">int</span> *active_set;</div><div class="line">    <span class="keyword">double</span> *G_bar;      <span class="comment">// gradient, if we treat free variables as 0</span></div><div class="line">    <span class="keyword">int</span> l;</div><div class="line">    <span class="keyword">bool</span> unshrink;  <span class="comment">// XXX</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">double</span> <span class="title">get_C</span><span class="params">(<span class="keyword">int</span> i)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> (y[i] &gt; <span class="number">0</span>) ? Cp : Cn;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">update_alpha_status</span><span class="params">(<span class="keyword">int</span> i)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">if</span> (alpha[i] &gt;= get_C(i))</div><div class="line">            alpha_status[i] = UPPER_BOUND;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (alpha[i] &lt;= <span class="number">0</span>)</div><div class="line">            alpha_status[i] = LOWER_BOUND;</div><div class="line">        <span class="keyword">else</span> alpha_status[i] = FREE;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">is_upper_bound</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123; <span class="keyword">return</span> alpha_status[i] == UPPER_BOUND; &#125;</div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">is_lower_bound</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123; <span class="keyword">return</span> alpha_status[i] == LOWER_BOUND; &#125;</div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">is_free</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123; <span class="keyword">return</span> alpha_status[i] == FREE; &#125;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">swap_index</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reconstruct_gradient</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">select_working_set</span><span class="params">(<span class="keyword">int</span> &amp;i, <span class="keyword">int</span> &amp;j)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">double</span> <span class="title">calculate_rho</span><span class="params">()</span></span>;</div><div class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">do_shrinking</span><span class="params">()</span></span>;</div><div class="line"><span class="keyword">private</span>:</div><div class="line">    <span class="function"><span class="keyword">bool</span> <span class="title">be_shrunk</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">double</span> Gmax1, <span class="keyword">double</span> Gmax2)</span></span>;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="成员变量-1"><a href="#成员变量-1" class="headerlink" title="成员变量"></a>成员变量</h3><p>结构体SolutionInfo为求解优化中的参数信息。</p>
<p>各参数解释如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Parameter</th>
<th style="text-align:center">Interpretation</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">SolutionInfo.obj</td>
<td style="text-align:center">求解优化过程中的目标函数值</td>
</tr>
<tr>
<td style="text-align:center">SolutionInfo.rho</td>
<td style="text-align:center">判别函数中的b</td>
</tr>
<tr>
<td style="text-align:center">SolutionInfo.upper_bound_p</td>
<td style="text-align:center">对于不平衡数据集，该值对应惩罚因子Cp</td>
</tr>
<tr>
<td style="text-align:center">SolutionInfo.upper_bound_n</td>
<td style="text-align:center">对于不平衡数据集，该值对应惩罚因子Cn</td>
</tr>
<tr>
<td style="text-align:center">SolutionInfo.r</td>
<td style="text-align:center">用于Solver_NU</td>
</tr>
<tr>
<td style="text-align:center">active_size</td>
<td style="text-align:center">计算时实际参加运算的样本数目，经过shrink处理后，该数目会小于全部样本总数。</td>
</tr>
<tr>
<td style="text-align:center">*y</td>
<td style="text-align:center">样本所属类别，该值只取+1/-1 。虽然可以处理多类，最终是用两类SVM 完成的。</td>
</tr>
<tr>
<td style="text-align:center">*G</td>
<td style="text-align:center">梯度G=Qα+P</td>
</tr>
<tr>
<td style="text-align:center">*alpha_status</td>
<td style="text-align:center">α[i]的状态，根据情况分为α[i]≤0,α[i]≥c和0&lt;α[i]&lt;\c,分别对应内部点(非SV)，错分点(BSV)和支持向量(SV)。</td>
</tr>
<tr>
<td style="text-align:center">*alpha</td>
<td style="text-align:center">α[i]</td>
</tr>
<tr>
<td style="text-align:center">*Q</td>
<td style="text-align:center">对应公式中Q的某一列</td>
</tr>
<tr>
<td style="text-align:center">*QD</td>
<td style="text-align:center">对应公式中的Q[i][i]</td>
</tr>
<tr>
<td style="text-align:center">eps</td>
<td style="text-align:center">停止条件的误差限</td>
</tr>
<tr>
<td style="text-align:center">Cp，Cn</td>
<td style="text-align:center">对应不平衡数据的惩罚因子，若不为不平数据或是对于SVR来说Cp=Cn=C</td>
</tr>
<tr>
<td style="text-align:center">*p</td>
<td style="text-align:center">对应梯度公式中的p，即SVR中的间隔带epsilon</td>
</tr>
<tr>
<td style="text-align:center">*active_set</td>
<td style="text-align:center">active对应的index</td>
</tr>
<tr>
<td style="text-align:center">*G_bar</td>
<td style="text-align:center">sum(C*Q)</td>
</tr>
<tr>
<td style="text-align:center">l</td>
<td style="text-align:center">数据样本个数</td>
</tr>
<tr>
<td style="text-align:center">unshrink</td>
<td style="text-align:center">是否被压缩</td>
</tr>
</tbody>
</table>
</div>
<h3 id="成员函数-1"><a href="#成员函数-1" class="headerlink" title="成员函数"></a>成员函数</h3><h4 id="double-get-C-int-i-；"><a href="#double-get-C-int-i-；" class="headerlink" title="double get_C(int i)；"></a>double get_C(int i)；</h4><p>返回对应于样本的C。设置不同的Cp 和Cn 是为了处理数据的不平衡。见[1]中的Unbalanced data.对于一般样本数据Cp=Cn。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">double</span> <span class="title">get_C</span><span class="params">(<span class="keyword">int</span> i)</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> (y[i] &gt; <span class="number">0</span>) ? Cp : Cn;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h4 id="void-swap-index-int-i-int-j"><a href="#void-swap-index-int-i-int-j" class="headerlink" title="void swap_index(int i, int j);"></a>void swap_index(int i, int j);</h4><p>完全交换样本i和样本j的内容，包括所申请的内存的地址。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> Solver::swap_index(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</div><div class="line">&#123;</div><div class="line">    Q-&gt;swap_index(i, j);</div><div class="line">    swap(y[i], y[j]);</div><div class="line">    swap(G[i], G[j]);</div><div class="line">    swap(alpha_status[i], alpha_status[j]);</div><div class="line">    swap(alpha[i], alpha[j]);</div><div class="line">    swap(p[i], p[j]);</div><div class="line">    swap(active_set[i], active_set[j]);</div><div class="line">    swap(G_bar[i], G_bar[j]);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">template</span> &lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">static</span> <span class="title">inline</span> <span class="title">void</span> <span class="title">swap</span>(<span class="title">T</span>&amp; <span class="title">x</span>, <span class="title">T</span>&amp; <span class="title">y</span>) &#123;</span> T t = x; x = y; y = t; &#125;</div></pre></td></tr></table></figure>
<h4 id="void-reconstruct-gradient"><a href="#void-reconstruct-gradient" class="headerlink" title="void reconstruct_gradient();"></a>void reconstruct_gradient();</h4><p>重新计算梯度。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> Solver::reconstruct_gradient()</div><div class="line">&#123;</div><div class="line">    <span class="comment">// reconstruct inactive elements of G from G_bar and free variables</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (active_size == l) <span class="keyword">return</span>;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> i, j;</div><div class="line">    <span class="keyword">int</span> nr_free = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (j = active_size; j&lt;l; j++)</div><div class="line">        G[j] = G_bar[j] + p[j];</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j&lt;active_size; j++)</div><div class="line">        <span class="keyword">if</span> (is_free(j))</div><div class="line">            nr_free++;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="number">2</span> * nr_free &lt; active_size)</div><div class="line">        info(<span class="string">"\nWARNING: using -h 0 may be faster\n"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (nr_free*l &gt; <span class="number">2</span> * active_size*(l - active_size))</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">for</span> (i = active_size; i&lt;l; i++)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">const</span> Qfloat *Q_i = Q-&gt;get_Q(i, active_size);</div><div class="line">            <span class="keyword">for</span> (j = <span class="number">0</span>; j&lt;active_size; j++)</div><div class="line">                <span class="keyword">if</span> (is_free(j))</div><div class="line">                    G[i] += alpha[j] * Q_i[j];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;active_size; i++)</div><div class="line">            <span class="keyword">if</span> (is_free(i))</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">const</span> Qfloat *Q_i = Q-&gt;get_Q(i, l);</div><div class="line">                <span class="keyword">double</span> alpha_i = alpha[i];</div><div class="line">                <span class="keyword">for</span> (j = active_size; j&lt;l; j++)</div><div class="line">                    G[j] += alpha_i * Q_i[j];</div><div class="line">            &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>G_bar[i]在初始化时并未加入p[i]，所以程序首先增加p[i]。Shrink后依然参加运算的样本位于active_size和l-1位置上。在0～active_size之间的alpha[i]如果在区间(0,c)上，才有必要更新相应的active_size和l-1位置上的样本的梯度。</p>
<h4 id="virtual-void-do-shrinking"><a href="#virtual-void-do-shrinking" class="headerlink" title="virtual void do_shrinking();"></a>virtual void do_shrinking();</h4><p>对样本集做缩减。当0&lt;α&lt;C时(还有两种情况),程序认为该样本可以不参加下次迭代。(0&lt;α&lt;C时，为内部点)程序会减小active_size，为内部点增加位置。active_size表明了不可以参加下次迭代的样本的最小标签号，在active_size与l之间的元素都对分类没有贡献。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> Solver::do_shrinking()</div><div class="line">&#123;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    <span class="keyword">double</span> Gmax1 = -INF;        <span class="comment">// max &#123; -y_i * grad(f)_i | i in I_up(\alpha) &#125;</span></div><div class="line">    <span class="keyword">double</span> Gmax2 = -INF;        <span class="comment">// max &#123; y_i * grad(f)_i | i in I_low(\alpha) &#125;</span></div><div class="line"></div><div class="line">                                <span class="comment">// find maximal violating pair first</span></div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;active_size; i++)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (y[i] == +<span class="number">1</span>)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (!is_upper_bound(i))    <span class="comment">// &lt; C</span></div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span> (-G[i] &gt;= Gmax1)</div><div class="line">                    Gmax1 = -G[i];</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!is_lower_bound(i))</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span> (G[i] &gt;= Gmax2)</div><div class="line">                    Gmax2 = G[i];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (!is_upper_bound(i))</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span> (-G[i] &gt;= Gmax2)</div><div class="line">                    Gmax2 = -G[i];</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (!is_lower_bound(i))</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span> (G[i] &gt;= Gmax1)</div><div class="line">                    Gmax1 = G[i];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//如果程序在缩减一次后没有达到结束条件，就重新构造梯度矢量，并再缩减一次。</span></div><div class="line">    <span class="keyword">if</span> (unshrink == <span class="literal">false</span> &amp;&amp; Gmax1 + Gmax2 &lt;= eps * <span class="number">10</span>)</div><div class="line">    &#123;</div><div class="line">        unshrink = <span class="literal">true</span>;</div><div class="line">        reconstruct_gradient();</div><div class="line">        active_size = l;</div><div class="line">        info(<span class="string">"*"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="comment">//程序中active_size--是为了消除交换后的影响，使重新换来的样本也被检查一次。</span></div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;active_size; i++)</div><div class="line">        <span class="keyword">if</span> (be_shrunk(i, Gmax1, Gmax2))</div><div class="line">        &#123;</div><div class="line">            active_size--;</div><div class="line">            <span class="keyword">while</span> (active_size &gt; i)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span> (!be_shrunk(active_size, Gmax1, Gmax2))</div><div class="line">                &#123;</div><div class="line">                    swap_index(i, active_size);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                active_size--;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="virtual-int-select-working-set-int-amp-i-int-amp-j"><a href="#virtual-int-select-working-set-int-amp-i-int-amp-j" class="headerlink" title="virtual int select_working_set(int &amp;i, int &amp;j);"></a>virtual int select_working_set(int &amp;i, int &amp;j);</h4><p>该函数求解出违反KKT条件最严重的目标对i与j。<br>我们先来了解一下working set的选择原理。参考文献[3]。</p>
<h5 id="选择i"><a href="#选择i" class="headerlink" title="选择i"></a>选择i</h5><p>SVM的对偶问题为：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_4.jpg?raw=true" alt="Loading..."></p>
<p>SVM收敛的充分必要条件(KKT条件)为：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_5.jpg?raw=true" alt="Loading..."></p>
<p>对(1)式求导可以得到：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_6.jpg?raw=true" alt="Loading..."><br>①yi=1，αi&lt;C，由(2)和(3)可得：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_7.jpg?raw=true" alt="Loading..."></p>
<p>②yi=-1，αi&gt;0，由(2)和(3)可得：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_8.jpg?raw=true" alt="Loading..."></p>
<p>③yi=-1，αi&lt;C，由(2)和(3)可得：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_9.jpg?raw=true" alt="Loading..."></p>
<p>④yi=1，αi&gt;0，由(2)和(3)可得：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_10.jpg?raw=true" alt="Loading..."></p>
<p>对式(4)、(5)、(6)、(7)进行约简得到式(8):<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_11.jpg?raw=true" alt="Loading..."></p>
<p>可以发现，(4)和(5)都是b大于某个数，(6)和(7)都是b小于某个数。那么我可以发现，(4)和(5)都是b大于某个数，(6)和(7)都是b小于某个数。因为b是个常量，那么根据上述条件，我们可以得到以下结论，在合理的αi和αj下，有：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_12.jpg?raw=true" alt="Loading..."></p>
<p>我们就是要从中挑选违反上述条件的αi和αj，来进行重新的迭代和更新，使得所有的αi和αj都满足上述条件。那么我们可以很容易得到违反条件为：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_13.jpg?raw=true" alt="Loading..."></p>
<p>则根据式(8)中关于i的选择就可以明白select_working_set函数中关于选择i的部分了。</p>
<h5 id="选择j"><a href="#选择j" class="headerlink" title="选择j"></a>选择j</h5><p>当yi<em>yj</em>K(i,j)为半正定矩阵时，当且仅当待优化乘子为“违反对”时，目标函数是严格递减的。LibSVM在做选择的时候，采用的是second order information方法。那么我们挑选出了i之后，剩下的任务就是挑选出既是“违反对”同时使目标函数值最小。补充一下：挑选了“违反对”，自然就使得目标函数自然递减了，那么我们挑选目标函数最小，自然使得迭代速度加快。这是我们希望看到的结果。</p>
<p>使用泰勒展开式：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_14.jpg?raw=true" alt="Loading..."></p>
<p>则优化问题变为：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_15.jpg?raw=true" alt="Loading..."></p>
<p>由约束条件可知：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_16.jpg?raw=true" alt="Loading..."></p>
<p>因为0≤α≤c,所以当α取到极值的时候，d的取值是有限制的，使得最终的α+d的值不会超出α取值范围。</p>
<p>则原优化问题可转换为下述优化问题：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_17.jpg?raw=true" alt="Loading..."></p>
<p>最小值为：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_18.jpg?raw=true" alt="Loading..."></p>
<p>证明如下(可参考文献[3]的Theorem 3)：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_19.jpg?raw=true" alt="Loading..."></p>
<p>结论貌似挺复杂的，其实不然，仔细观察发现式(13)其实就是一个一元二次函数，对其求极值，得该函数的最小值。<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/n_20.jpg?raw=true" alt="Loading..."></p>
<p>下面我们来看一下代码：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> Solver::select_working_set(<span class="keyword">int</span> &amp;out_i, <span class="keyword">int</span> &amp;out_j)</div><div class="line">&#123;</div><div class="line">    <span class="comment">// return i,j such that</span></div><div class="line">    <span class="comment">// i: maximizes -y_i * grad(f)_i, i in I_up(\alpha)</span></div><div class="line">    <span class="comment">// j: minimizes the decrease of obj value</span></div><div class="line">    <span class="comment">//    (if quadratic coefficeint &lt;= 0, replace it with tau)</span></div><div class="line">    <span class="comment">//    -y_j*grad(f)_j &lt; -y_i*grad(f)_i, j in I_low(\alpha)</span></div><div class="line"></div><div class="line">    <span class="keyword">double</span> Gmax = -INF;    <span class="comment">//-yi*G(alphai)</span></div><div class="line">    <span class="keyword">double</span> Gmax2 = -INF;    <span class="comment">//yj*G(alphaj)</span></div><div class="line">    <span class="keyword">int</span> Gmax_idx = <span class="number">-1</span>;</div><div class="line">    <span class="keyword">int</span> Gmin_idx = <span class="number">-1</span>;</div><div class="line">    <span class="keyword">double</span> obj_diff_min = INF;</div><div class="line"></div><div class="line">    <span class="comment">//寻找working set B中的i</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> t = <span class="number">0</span>; t&lt;active_size; t++)</div><div class="line">        <span class="keyword">if</span> (y[t] == +<span class="number">1</span>)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (!is_upper_bound(t)) <span class="comment">//对应于yi=1,alphai&lt;c</span></div><div class="line">                <span class="keyword">if</span> (-G[t] &gt;= Gmax)</div><div class="line">                &#123;</div><div class="line">                    Gmax = -G[t];   <span class="comment">//寻找最大的-yi*G(alphai)，以使违反条件最严重</span></div><div class="line">                    Gmax_idx = t;</div><div class="line">                &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (!is_lower_bound(t)) <span class="comment">//对应于yi=1,alphai&gt;0</span></div><div class="line">                <span class="keyword">if</span> (G[t] &gt;= Gmax)</div><div class="line">                &#123;</div><div class="line">                    Gmax = G[t];</div><div class="line">                    Gmax_idx = t;</div><div class="line">                &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> i = Gmax_idx;   <span class="comment">//得到i</span></div><div class="line">    <span class="keyword">const</span> Qfloat *Q_i = <span class="literal">NULL</span>;</div><div class="line">    <span class="keyword">if</span> (i != <span class="number">-1</span>) <span class="comment">// NULL Q_i not accessed: Gmax=-INF if i=-1</span></div><div class="line">        Q_i = Q-&gt;get_Q(i, active_size);</div><div class="line"></div><div class="line">    <span class="comment">//寻找working set B中的j</span></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j&lt;active_size; j++)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (y[j] == +<span class="number">1</span>)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (!is_lower_bound(j))</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">double</span> grad_diff = Gmax + G[j];    <span class="comment">//分子(-yi*Gi+yj*Gj)</span></div><div class="line">                <span class="keyword">if</span> (G[j] &gt;= Gmax2)  <span class="comment">//寻找最小的-yj*G(alphaj)</span></div><div class="line">                    Gmax2 = G[j];</div><div class="line">                <span class="keyword">if</span> (grad_diff &gt; <span class="number">0</span>)      <span class="comment">//保证不满足KKT条件</span></div><div class="line">                &#123;</div><div class="line">                    <span class="keyword">double</span> obj_diff;</div><div class="line">                    <span class="keyword">double</span> quad_coef = QD[i] + QD[j] - <span class="number">2.0</span>*y[i] * Q_i[j];    <span class="comment">//分母(Kii+Kjj-2*Kij),注意Kij和Qij的关系(SVR_Q类中会讲)</span></div><div class="line">                    <span class="keyword">if</span> (quad_coef &gt; <span class="number">0</span>)</div><div class="line">                        obj_diff = -(grad_diff*grad_diff) / quad_coef;</div><div class="line">                    <span class="keyword">else</span></div><div class="line">                        obj_diff = -(grad_diff*grad_diff) / TAU;    <span class="comment">//当quad_coef小于0时令其等于一个很小很小的值。</span></div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (obj_diff &lt;= obj_diff_min)</div><div class="line">                    &#123;</div><div class="line">                        Gmin_idx = j;</div><div class="line">                        obj_diff_min = obj_diff;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (!is_upper_bound(j))</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">double</span> grad_diff = Gmax - G[j];</div><div class="line">                <span class="keyword">if</span> (-G[j] &gt;= Gmax2)</div><div class="line">                    Gmax2 = -G[j];</div><div class="line">                <span class="keyword">if</span> (grad_diff &gt; <span class="number">0</span>)</div><div class="line">                &#123;</div><div class="line">                    <span class="keyword">double</span> obj_diff;</div><div class="line">                    <span class="keyword">double</span> quad_coef = QD[i] + QD[j] + <span class="number">2.0</span>*y[i] * Q_i[j];</div><div class="line">                    <span class="keyword">if</span> (quad_coef &gt; <span class="number">0</span>)</div><div class="line">                        obj_diff = -(grad_diff*grad_diff) / quad_coef;</div><div class="line">                    <span class="keyword">else</span></div><div class="line">                        obj_diff = -(grad_diff*grad_diff) / TAU;</div><div class="line"></div><div class="line">                    <span class="keyword">if</span> (obj_diff &lt;= obj_diff_min)</div><div class="line">                    &#123;</div><div class="line">                        Gmin_idx = j;</div><div class="line">                        obj_diff_min = obj_diff;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (Gmax + Gmax2 &lt; eps || Gmin_idx == <span class="number">-1</span>)    <span class="comment">//达到停止条件或再没有需要优化的alpha，表示已经完全优化</span></div><div class="line">        <span class="keyword">return</span> <span class="number">1</span>;</div><div class="line"></div><div class="line">    out_i = Gmax_idx;</div><div class="line">    out_j = Gmin_idx;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="void-Solve-int-l-const-QMatrix-amp-Q-const-double-p-const-schar-y-double-alpha-double-Cp-double-Cn-double-eps-SolutionInfo-si-int-shrinking"><a href="#void-Solve-int-l-const-QMatrix-amp-Q-const-double-p-const-schar-y-double-alpha-double-Cp-double-Cn-double-eps-SolutionInfo-si-int-shrinking" class="headerlink" title="void Solve(int l, const QMatrix&amp; Q, const double *p_, const schar *y_, double *alpha_, double Cp, double Cn, double eps, SolutionInfo* si, int shrinking);"></a>void Solve(int l, const QMatrix&amp; Q, const double *p_, const schar *y_, double *alpha_, double Cp, double Cn, double eps, SolutionInfo* si, int shrinking);</h4><p>Solve函数用于求解更新alpha，下面讲解一下其求解原理，主要是SMO算法原理。这里主要还是以C-SVC为例，在后面讲解SVR_Q类时会解释如何将其扩展至回归分析。</p>
<p>SVM寻找超平面的公式为：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/21.jpg?raw=true" alt="Loading..."></p>
<p>其对偶问题为：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/22.jpg?raw=true" alt="Loading..."></p>
<p>将其表示为矩阵形式可变换为：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/23.jpg?raw=true" alt="Loading..."></p>
<p>其中C&gt;0为上界，e是数值全为1的行向量，Q是l*l的半正定矩阵，Qij=yi*yj*K(i,j)，K(i,j)=φ(Xi)^T*φ(Xj)为核函数。</p>
<p>当然，这只是LIBSVM中的C-SVC的目标公式，<strong>LIBSVM采用的是更加通用的目标公式</strong>：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/24.jpg?raw=true" alt="Loading..."></p>
<p>其中p是长度为l的行向量，△为常数。</p>
<p>其求导为：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/27.jpg?raw=true" alt="Loading..."></p>
<p>于是令aij = Kii+Kjj-2*Kij，假设选定的working set B为i和j，将其带入上式。（见文献[2]的Algorithm 1）<br>当aij&gt;0时得：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/25.jpg?raw=true" alt="Loading..."></p>
<p>当aij≤0时，约束同上式，令：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/26.jpg?raw=true" alt="Loading..."></p>
<p>上式加的一项看似复杂，其实就是函数select_working_set中写的，当aij小于0时令其等于一个很小很小的值。</p>
<p><strong>工作集i,j的选择</strong><br>参见select_working_set函数的讲解。</p>
<p><strong>αi,αj的更新</strong><br>参考文献[2]的“5 Unbalanced Data”。</p>
<p>令：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/28.jpg?raw=true" alt="Loading..."></p>
<p>则问题：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/29.jpg?raw=true" alt="Loading..."></p>
<p>可转化为问题：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/30.jpg?raw=true" alt="Loading..."></p>
<p>进而求解出di,dj可以得到更新后的α，即：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/31.jpg?raw=true" alt="Loading..."></p>
<p>其中：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/32.jpg?raw=true" alt="Loading..."></p>
<p>以不考虑非均衡样本为例(即Cp=Cn)。<br>当yi≠yj时：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/33.jpg?raw=true" alt="Loading..."></p>
<p>当yi=yj时：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/34.jpg?raw=true" alt="Loading..."></p>
<p><strong>梯度G的更新</strong><br>G[α(k)] = Q[α(k)] + p<br>G[α(k+1)] = Q[α(k+1)] + p<br>则：<br>G[α(k+1)] = G[α(k)] + Q[α(k+1)-α(k)]</p>
<p><strong>G_bar的更新</strong><br>G_bar[i] = {C * sum(Q[i,j]) while α[j]=C}    i = 1,2,3,… l<br>因此，若α更新前后状态(alpha_status)不变，如都为C或都小于C，则G_bar不变。<br>否则：<br>①迭代前不为C，迭代后为C，则：<br>G_bar(k+1)[i] = {C * sum(Q[i,j]) while α[j]=C}<br>②迭代前为C，迭代后不为C，则：<br>G_bar(k+1)[i] = G_bar(k)[i] - {C * sum(Q[i,j]) while α[j]=C}</p>
<p>下面我们开始看代码。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">void</span> Solver::Solve(<span class="keyword">int</span> l, <span class="keyword">const</span> QMatrix&amp; Q, <span class="keyword">const</span> <span class="keyword">double</span> *p_, <span class="keyword">const</span> schar *y_,</div><div class="line">    <span class="keyword">double</span> *alpha_, <span class="keyword">double</span> Cp, <span class="keyword">double</span> Cn, <span class="keyword">double</span> eps,</div><div class="line">    SolutionInfo* si, <span class="keyword">int</span> shrinking)</div><div class="line">&#123;</div><div class="line">    <span class="keyword">this</span>-&gt;l = l;</div><div class="line">    <span class="keyword">this</span>-&gt;Q = &amp;Q;</div><div class="line">    QD = Q.get_QD();</div><div class="line">    clone(p, p_, l);</div><div class="line">    clone(y, y_, l);</div><div class="line">    clone(alpha, alpha_, l);</div><div class="line">    <span class="keyword">this</span>-&gt;Cp = Cp;</div><div class="line">    <span class="keyword">this</span>-&gt;Cn = Cn;</div><div class="line">    <span class="keyword">this</span>-&gt;eps = eps;</div><div class="line">    unshrink = <span class="literal">false</span>;</div><div class="line"></div><div class="line">    <span class="comment">// initialize alpha_status</span></div><div class="line">    &#123;</div><div class="line">        alpha_status = <span class="keyword">new</span> <span class="keyword">char</span>[l];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt;l; i++)</div><div class="line">            update_alpha_status(i);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// initialize active set (for shrinking)</span></div><div class="line">    &#123;</div><div class="line">        active_set = <span class="keyword">new</span> <span class="keyword">int</span>[l];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt;l; i++)</div><div class="line">            active_set[i] = i;</div><div class="line">        active_size = l;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// initialize gradient，根据梯度定义公式进行初始化</span></div><div class="line">    &#123;</div><div class="line">        G = <span class="keyword">new</span> <span class="keyword">double</span>[l];</div><div class="line">        G_bar = <span class="keyword">new</span> <span class="keyword">double</span>[l];</div><div class="line">        <span class="keyword">int</span> i;</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;l; i++)</div><div class="line">        &#123;</div><div class="line">            G[i] = p[i];</div><div class="line">            G_bar[i] = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;l; i++)</div><div class="line">            <span class="keyword">if</span> (!is_lower_bound(i))</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">const</span> Qfloat *Q_i = Q.get_Q(i, l);</div><div class="line">                <span class="keyword">double</span> alpha_i = alpha[i];</div><div class="line">                <span class="keyword">int</span> j;</div><div class="line">                <span class="keyword">for</span> (j = <span class="number">0</span>; j&lt;l; j++)</div><div class="line">                    G[j] += alpha_i * Q_i[j];</div><div class="line">                <span class="keyword">if</span> (is_upper_bound(i))</div><div class="line">                    <span class="keyword">for</span> (j = <span class="number">0</span>; j&lt;l; j++)</div><div class="line">                        G_bar[j] += get_C(i) * Q_i[j];</div><div class="line">            &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// optimization step</span></div><div class="line"></div><div class="line">    <span class="keyword">int</span> iter = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> max_iter = max(<span class="number">10000000</span>, l&gt;INT_MAX / <span class="number">100</span> ? INT_MAX : <span class="number">100</span> * l);</div><div class="line">    <span class="keyword">int</span> counter = min(l, <span class="number">1000</span>) + <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (iter &lt; max_iter)</div><div class="line">    &#123;</div><div class="line">        <span class="comment">// show progress and do shrinking</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> (--counter == <span class="number">0</span>)</div><div class="line">        &#123;</div><div class="line">            counter = min(l, <span class="number">1000</span>);</div><div class="line">            <span class="keyword">if</span> (shrinking) do_shrinking();</div><div class="line">            info(<span class="string">"do shrinking.\n"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> i, j;</div><div class="line">        <span class="keyword">if</span> (select_working_set(i, j) != <span class="number">0</span>)</div><div class="line">        &#123;</div><div class="line">            <span class="comment">// reconstruct the whole gradient</span></div><div class="line">            reconstruct_gradient();</div><div class="line">            <span class="comment">// reset active set size and check</span></div><div class="line">            active_size = l;</div><div class="line">            info(<span class="string">"reconstruct G*\n"</span>);</div><div class="line">            <span class="keyword">if</span> (select_working_set(i, j) != <span class="number">0</span>) &#123;</div><div class="line">                info(<span class="string">"======break======"</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span></div><div class="line">                counter = <span class="number">1</span>;    <span class="comment">// do shrinking next iteration</span></div><div class="line">        &#125;</div><div class="line">        ++iter;</div><div class="line"></div><div class="line">        <span class="comment">// update alpha[i] and alpha[j], handle bounds carefully</span></div><div class="line"></div><div class="line">        <span class="keyword">const</span> Qfloat *Q_i = Q.get_Q(i, active_size);</div><div class="line">        <span class="keyword">const</span> Qfloat *Q_j = Q.get_Q(j, active_size);</div><div class="line"></div><div class="line">        <span class="keyword">double</span> C_i = get_C(i);</div><div class="line">        <span class="keyword">double</span> C_j = get_C(j);</div><div class="line"></div><div class="line">        <span class="keyword">double</span> old_alpha_i = alpha[i];</div><div class="line">        <span class="keyword">double</span> old_alpha_j = alpha[j];</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (y[i] != y[j])   <span class="comment">//# yi,yj异号</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">double</span> quad_coef = QD[i] + QD[j] + <span class="number">2</span> * Q_i[j];  <span class="comment">//最后一个为+号因为Qij为kij*y[i]*y[j]</span></div><div class="line">            <span class="keyword">if</span> (quad_coef &lt;= <span class="number">0</span>)</div><div class="line">                quad_coef = TAU;</div><div class="line">            <span class="keyword">double</span> delta = (-G[i] - G[j]) / quad_coef;  <span class="comment">//alpha改变量</span></div><div class="line">            <span class="keyword">double</span> diff = alpha[i] - alpha[j];  <span class="comment">//根据此项判断alpha(i)-alpha(j)=constant与约束框(0~c)的交点</span></div><div class="line">            alpha[i] += delta;</div><div class="line">            alpha[j] += delta;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (diff &gt; <span class="number">0</span>)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span> (alpha[j] &lt; <span class="number">0</span>)</div><div class="line">                &#123;</div><div class="line">                    alpha[j] = <span class="number">0</span>;</div><div class="line">                    alpha[i] = diff;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span></div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span> (alpha[i] &lt; <span class="number">0</span>)</div><div class="line">                &#123;</div><div class="line">                    alpha[i] = <span class="number">0</span>;</div><div class="line">                    alpha[j] = -diff;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (diff &gt; C_i - C_j)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span> (alpha[i] &gt; C_i)</div><div class="line">                &#123;</div><div class="line">                    alpha[i] = C_i;</div><div class="line">                    alpha[j] = C_i - diff;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span></div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span> (alpha[j] &gt; C_j)</div><div class="line">                &#123;</div><div class="line">                    alpha[j] = C_j;</div><div class="line">                    alpha[i] = C_j + diff;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">double</span> quad_coef = QD[i] + QD[j] - <span class="number">2</span> * Q_i[j];</div><div class="line">            <span class="keyword">if</span> (quad_coef &lt;= <span class="number">0</span>)</div><div class="line">                quad_coef = TAU;</div><div class="line">            <span class="keyword">double</span> delta = (G[i] - G[j]) / quad_coef;</div><div class="line">            <span class="keyword">double</span> sum = alpha[i] + alpha[j];</div><div class="line">            alpha[i] -= delta;</div><div class="line">            alpha[j] += delta;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (sum &gt; C_i)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span> (alpha[i] &gt; C_i)</div><div class="line">                &#123;</div><div class="line">                    alpha[i] = C_i;</div><div class="line">                    alpha[j] = sum - C_i;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span></div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span> (alpha[j] &lt; <span class="number">0</span>)</div><div class="line">                &#123;</div><div class="line">                    alpha[j] = <span class="number">0</span>;</div><div class="line">                    alpha[i] = sum;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (sum &gt; C_j)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span> (alpha[j] &gt; C_j)</div><div class="line">                &#123;</div><div class="line">                    alpha[j] = C_j;</div><div class="line">                    alpha[i] = sum - C_j;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span></div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span> (alpha[i] &lt; <span class="number">0</span>)</div><div class="line">                &#123;</div><div class="line">                    alpha[i] = <span class="number">0</span>;</div><div class="line">                    alpha[j] = sum;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// update G</span></div><div class="line"></div><div class="line">        <span class="keyword">double</span> delta_alpha_i = alpha[i] - old_alpha_i;</div><div class="line">        <span class="keyword">double</span> delta_alpha_j = alpha[j] - old_alpha_j;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k&lt;active_size; k++)</div><div class="line">        &#123;</div><div class="line">            G[k] += Q_i[k] * delta_alpha_i + Q_j[k] * delta_alpha_j;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// update alpha_status and G_bar</span></div><div class="line"></div><div class="line">        &#123;</div><div class="line">            <span class="keyword">bool</span> ui = is_upper_bound(i);</div><div class="line">            <span class="keyword">bool</span> uj = is_upper_bound(j);</div><div class="line">            update_alpha_status(i);</div><div class="line">            update_alpha_status(j);</div><div class="line">            <span class="keyword">int</span> k;</div><div class="line">            <span class="keyword">if</span> (ui != is_upper_bound(i))</div><div class="line">            &#123;</div><div class="line">                Q_i = Q.get_Q(i, l);</div><div class="line">                <span class="keyword">if</span> (ui)</div><div class="line">                    <span class="keyword">for</span> (k = <span class="number">0</span>; k&lt;l; k++)</div><div class="line">                        G_bar[k] -= C_i * Q_i[k];</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    <span class="keyword">for</span> (k = <span class="number">0</span>; k&lt;l; k++)</div><div class="line">                        G_bar[k] += C_i * Q_i[k];</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (uj != is_upper_bound(j))</div><div class="line">            &#123;</div><div class="line">                Q_j = Q.get_Q(j, l);</div><div class="line">                <span class="keyword">if</span> (uj)</div><div class="line">                    <span class="keyword">for</span> (k = <span class="number">0</span>; k&lt;l; k++)</div><div class="line">                        G_bar[k] -= C_j * Q_j[k];</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    <span class="keyword">for</span> (k = <span class="number">0</span>; k&lt;l; k++)</div><div class="line">                        G_bar[k] += C_j * Q_j[k];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"i:%d, j:%d, alpha_i:%f, alpha_j:%f\n"</span>, i, j, alpha[i], alpha[j]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (iter &gt;= max_iter)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (active_size &lt; l)</div><div class="line">        &#123;</div><div class="line">            <span class="comment">// reconstruct the whole gradient to calculate objective value</span></div><div class="line">            reconstruct_gradient();</div><div class="line">            active_size = l;</div><div class="line">            info(<span class="string">"*"</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"\nWARNING: reaching max number of iterations\n"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// calculate rho</span></div><div class="line"></div><div class="line">    si-&gt;rho = calculate_rho();</div><div class="line"></div><div class="line">    <span class="comment">// calculate objective value</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">double</span> v = <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> i;</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;l; i++)</div><div class="line">            v += alpha[i] * (G[i] + p[i]);</div><div class="line"></div><div class="line">        si-&gt;obj = v / <span class="number">2</span>;    <span class="comment">//目标值为(alpha^T*Q*alpha + p^T*alpha)</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// put back the solution</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt;l; i++)</div><div class="line">            alpha_[active_set[i]] = alpha[i];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// juggle everything back</span></div><div class="line">    <span class="comment">/*&#123;</span></div><div class="line"><span class="comment">    for(int i=0;i&lt;l;i++)</span></div><div class="line"><span class="comment">    while(active_set[i] != i)</span></div><div class="line"><span class="comment">    swap_index(i,active_set[i]);</span></div><div class="line"><span class="comment">    // or Q.swap_index(i,active_set[i]);</span></div><div class="line"><span class="comment">    &#125;*/</span></div><div class="line"></div><div class="line">    si-&gt;upper_bound_p = Cp;</div><div class="line">    si-&gt;upper_bound_n = Cn;</div><div class="line"></div><div class="line">    info(<span class="string">"\noptimization finished, #iter = %d\n"</span>, iter);</div><div class="line">    <span class="comment">/*for (int g = 0; g &lt; l/2; g++) &#123;</span></div><div class="line"><span class="comment">        printf("alpha_%d:%f\n", g, (alpha[g]-alpha[g+l/2]));</span></div><div class="line"><span class="comment">    &#125;*/</span></div><div class="line"></div><div class="line">    <span class="keyword">delete</span>[] p;</div><div class="line">    <span class="keyword">delete</span>[] y;</div><div class="line">    <span class="keyword">delete</span>[] alpha;</div><div class="line">    <span class="keyword">delete</span>[] alpha_status;</div><div class="line">    <span class="keyword">delete</span>[] active_set;</div><div class="line">    <span class="keyword">delete</span>[] G;</div><div class="line">    <span class="keyword">delete</span>[] G_bar;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="virtual-double-calculate-rho"><a href="#virtual-double-calculate-rho" class="headerlink" title="virtual double calculate_rho();"></a>virtual double calculate_rho();</h4><p>该函数用于计算判别函数中的b(rho为b的相反数)，参考文献[2]的3.6。<br>这里仅写出结果：<br>当yi=1时：<br>假设0&lt;αi&lt;C，则r1 = G[α](i)<br>为避免出现数值错误，一般将其写成平均值：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/35.jpg?raw=true" alt="Loading..."><br>如果没有这样的αi，则r1必须满足：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/36.jpg?raw=true" alt="Loading..."><br>此时将ri取为范围中点。<br>当yi=-1时，计算过程类似，得到r2。</p>
<p>得到r1、r2后，通过计算得到：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/37.jpg?raw=true" alt="Loading..."></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">double</span> Solver::calculate_rho()</div><div class="line">&#123;</div><div class="line">    <span class="keyword">double</span> r;</div><div class="line">    <span class="keyword">int</span> nr_free = <span class="number">0</span>;</div><div class="line">    <span class="keyword">double</span> ub = INF, lb = -INF, sum_free = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt;active_size; i++)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">double</span> yG = y[i] * G[i];</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (is_upper_bound(i))</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (y[i] == <span class="number">-1</span>)</div><div class="line">                ub = min(ub, yG);</div><div class="line">            <span class="keyword">else</span></div><div class="line">                lb = max(lb, yG);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (is_lower_bound(i))</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (y[i] == +<span class="number">1</span>)</div><div class="line">                ub = min(ub, yG);</div><div class="line">            <span class="keyword">else</span></div><div class="line">                lb = max(lb, yG);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            ++nr_free;</div><div class="line">            sum_free += yG;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (nr_free&gt;<span class="number">0</span>)</div><div class="line">        r = sum_free / nr_free;</div><div class="line">    <span class="keyword">else</span></div><div class="line">        r = (ub + lb) / <span class="number">2</span>;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> r;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="SVR-Q类"><a href="#SVR-Q类" class="headerlink" title="SVR_Q类"></a>SVR_Q类</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SVR_Q</span> :</span> <span class="keyword">public</span> Kernel</div><div class="line">&#123;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    SVR_Q(<span class="keyword">const</span> svm_problem&amp; prob, <span class="keyword">const</span> svm_parameter&amp; param)</div><div class="line">        :Kernel(prob.l, prob.x, param)</div><div class="line">    &#123;</div><div class="line">        l = prob.l;</div><div class="line">        cache = <span class="keyword">new</span> Cache(l, (<span class="keyword">long</span> <span class="keyword">int</span>)(param.cache_size*(<span class="number">1</span> &lt;&lt; <span class="number">20</span>)));</div><div class="line">        QD = <span class="keyword">new</span> <span class="keyword">double</span>[<span class="number">2</span> * l];</div><div class="line">        sign = <span class="keyword">new</span> schar[<span class="number">2</span> * l];</div><div class="line">        index = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span> * l];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k&lt;l; k++)</div><div class="line">        &#123;</div><div class="line">            sign[k] = <span class="number">1</span>;</div><div class="line">            sign[k + l] = <span class="number">-1</span>;</div><div class="line">            index[k] = k;</div><div class="line">            index[k + l] = k;</div><div class="line">            QD[k] = (<span class="keyword">this</span>-&gt;*kernel_function)(k, k);</div><div class="line">            QD[k + l] = QD[k];</div><div class="line">        &#125;</div><div class="line">        buffer[<span class="number">0</span>] = <span class="keyword">new</span> Qfloat[<span class="number">2</span> * l];</div><div class="line">        buffer[<span class="number">1</span>] = <span class="keyword">new</span> Qfloat[<span class="number">2</span> * l];</div><div class="line">        next_buffer = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">swap_index</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> j)</span> <span class="keyword">const</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        swap(sign[i], sign[j]);</div><div class="line">        swap(index[i], index[j]);</div><div class="line">        swap(QD[i], QD[j]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function">Qfloat *<span class="title">get_Q</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> len)</span> <span class="keyword">const</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        Qfloat *data;</div><div class="line">        <span class="keyword">int</span> j, real_i = index[i];</div><div class="line">        <span class="keyword">if</span> (cache-&gt;get_data(real_i, &amp;data, l) &lt; l)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">for</span> (j = <span class="number">0</span>; j&lt;l; j++)</div><div class="line">                data[j] = (Qfloat)(<span class="keyword">this</span>-&gt;*kernel_function)(real_i, j);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// reorder and copy</span></div><div class="line">        Qfloat *buf = buffer[next_buffer];</div><div class="line">        next_buffer = <span class="number">1</span> - next_buffer;</div><div class="line">        schar si = sign[i];</div><div class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j&lt;len; j++)</div><div class="line">            buf[j] = (Qfloat)si * (Qfloat)sign[j] * data[index[j]];</div><div class="line">        <span class="keyword">return</span> buf;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">double</span> *<span class="title">get_QD</span><span class="params">()</span> <span class="keyword">const</span></span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        <span class="keyword">return</span> QD;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ~SVR_Q()</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">delete</span> cache;</div><div class="line">        <span class="keyword">delete</span>[] sign;</div><div class="line">        <span class="keyword">delete</span>[] index;</div><div class="line">        <span class="keyword">delete</span>[] buffer[<span class="number">0</span>];</div><div class="line">        <span class="keyword">delete</span>[] buffer[<span class="number">1</span>];</div><div class="line">        <span class="keyword">delete</span>[] QD;</div><div class="line">    &#125;</div><div class="line"><span class="keyword">private</span>:</div><div class="line">    <span class="keyword">int</span> l;</div><div class="line">    Cache *cache;</div><div class="line">    schar *sign;</div><div class="line">    <span class="keyword">int</span> *index;</div><div class="line">    <span class="keyword">mutable</span> <span class="keyword">int</span> next_buffer;</div><div class="line">    Qfloat *buffer[<span class="number">2</span>];</div><div class="line">    <span class="keyword">double</span> *QD;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h3 id="成员变量-2"><a href="#成员变量-2" class="headerlink" title="成员变量"></a>成员变量</h3><p>主要参数解释如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Parameter</th>
<th style="text-align:center">Interpretation</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">*sign</td>
<td style="text-align:center">同SVC_Q中的y，即为公式中的y。sign[i]=1,sign[i+l]=-1,i=1,2,3,…,l</td>
</tr>
</tbody>
</table>
</div>
<h3 id="成员函数-2"><a href="#成员函数-2" class="headerlink" title="成员函数"></a>成员函数</h3><h4 id="SVR-Q-const-svm-problem-amp-prob-const-svm-parameter-amp-param-Kernel-prob-l-prob-x-param"><a href="#SVR-Q-const-svm-problem-amp-prob-const-svm-parameter-amp-param-Kernel-prob-l-prob-x-param" class="headerlink" title="SVR_Q(const svm_problem&amp; prob, const svm_parameter&amp; param):Kernel(prob.l, prob.x, param);"></a>SVR_Q(const svm_problem&amp; prob, const svm_parameter&amp; param):Kernel(prob.l, prob.x, param);</h4><p>初始化有关SVR的计算参数。与SVC不同的是优化公式中的y并不是SVR样本数据的目标值，优化公式中的l为两倍的SVR数据样本数量，详见solve_epsilon_svr函数解析。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">SVR_Q(<span class="keyword">const</span> svm_problem&amp; prob, <span class="keyword">const</span> svm_parameter&amp; param)</div><div class="line">        :Kernel(prob.l, prob.x, param)</div><div class="line">    &#123;</div><div class="line">        l = prob.l;    <span class="comment">//l为样本数据的数量</span></div><div class="line">        cache = <span class="keyword">new</span> Cache(l, (<span class="keyword">long</span> <span class="keyword">int</span>)(param.cache_size*(<span class="number">1</span> &lt;&lt; <span class="number">20</span>)));</div><div class="line">        <span class="comment">//对于SVR而言需要开辟2*l的空间</span></div><div class="line">        QD = <span class="keyword">new</span> <span class="keyword">double</span>[<span class="number">2</span> * l];</div><div class="line">        sign = <span class="keyword">new</span> schar[<span class="number">2</span> * l];</div><div class="line">        index = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span> * l];</div><div class="line"></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k&lt;l; k++)</div><div class="line">        &#123;</div><div class="line">            <span class="comment">//sign[i]=1,sign[i+l]=-1,i=1,2,3,...,l</span></div><div class="line">            sign[k] = <span class="number">1</span>;</div><div class="line">            sign[k + l] = <span class="number">-1</span>;</div><div class="line"></div><div class="line">            index[k] = k;</div><div class="line">            index[k + l] = k;</div><div class="line"></div><div class="line">            QD[k] = (<span class="keyword">this</span>-&gt;*kernel_function)(k, k);</div><div class="line">            QD[k + l] = QD[k];</div><div class="line">        &#125;</div><div class="line">        buffer[<span class="number">0</span>] = <span class="keyword">new</span> Qfloat[<span class="number">2</span> * l];</div><div class="line">        buffer[<span class="number">1</span>] = <span class="keyword">new</span> Qfloat[<span class="number">2</span> * l];</div><div class="line">        next_buffer = <span class="number">0</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h4 id="Qfloat-get-Q-int-i-int-len-const"><a href="#Qfloat-get-Q-int-i-int-len-const" class="headerlink" title="Qfloat *get_Q(int i, int len) const;"></a>Qfloat *get_Q(int i, int len) const;</h4><p>计算SVR公式中所使用的Q[i]，此处为第i列，不过一般而言Q[i,j]=Q[j,i]。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function">Qfloat *<span class="title">get_Q</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">int</span> len)</span> <span class="keyword">const</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    Qfloat *data;</div><div class="line">    <span class="keyword">int</span> j, real_i = index[i];</div><div class="line">    <span class="keyword">if</span> (cache-&gt;get_data(real_i, &amp;data, l) &lt; l)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j&lt;l; j++)</div><div class="line">            data[j] = (Qfloat)(<span class="keyword">this</span>-&gt;*kernel_function)(real_i, j);    <span class="comment">//计算得到K[i,j]</span></div><div class="line">    &#125;   </div><div class="line"></div><div class="line">    <span class="comment">// reorder and copy</span></div><div class="line">    Qfloat *buf = buffer[next_buffer];</div><div class="line">    next_buffer = <span class="number">1</span> - next_buffer;</div><div class="line">    schar si = sign[i];</div><div class="line">    <span class="keyword">for</span> (j = <span class="number">0</span>; j&lt;len; j++)</div><div class="line">        buf[j] = (Qfloat)si * (Qfloat)sign[j] * data[index[j]];    <span class="comment">//为了与Solver类中的公式相匹配，此处定义Q[i,j]=sign[i]*sign[j]*K[i,j]</span></div><div class="line">    <span class="keyword">return</span> buf;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="static-void-solve-epsilon-svr-const-svm-problem-prob-const-svm-parameter-param-double-alpha-Solver-SolutionInfo-si"><a href="#static-void-solve-epsilon-svr-const-svm-problem-prob-const-svm-parameter-param-double-alpha-Solver-SolutionInfo-si" class="headerlink" title="static void solve_epsilon_svr(const svm_problem *prob, const svm_parameter *param, double *alpha, Solver::SolutionInfo* si)"></a>static void solve_epsilon_svr(const svm_problem *prob, const svm_parameter *param, double *alpha, Solver::SolutionInfo* si)</h2><p>该函数用于计算优化公式中的p，并定义Solver中的y与α，调用Solver类。</p>
<p>epsilon-SVR原始公式为：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/38.jpg?raw=true" alt="Loading..."></p>
<p>其对偶式为：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/39.jpg?raw=true" alt="Loading..."></p>
<p>其中：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/40.jpg?raw=true" alt="Loading..."></p>
<p>决策函数为：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/41.jpg?raw=true" alt="Loading..."></p>
<p>将其化为矩阵形式：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/42.jpg?raw=true" alt="Loading..."></p>
<p>其中y为2l*1的矩阵，yt=1，t=1,…,l; yt=-1，t=l+1,…,2l.</p>
<p>将上式与前述的通用目标公式相比较，记上标t为通用公式的参数，则可知：<br><img src="https://github.com/KunBB/MarkdownPhotos/blob/master/LibSVM%E6%94%AF%E6%8C%81%E5%90%91%E9%87%8F%E5%9B%9E%E5%BD%92%E8%AF%A6%E8%A7%A3/43.jpg?raw=true" alt="Loading..."></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">solve_epsilon_svr</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params">    <span class="keyword">const</span> svm_problem *prob, <span class="keyword">const</span> svm_parameter *param,</span></span></div><div class="line"><span class="function"><span class="params">    <span class="keyword">double</span> *alpha, Solver::SolutionInfo* si)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">int</span> l = prob-&gt;l;</div><div class="line">    <span class="keyword">double</span> *alpha2 = <span class="keyword">new</span> <span class="keyword">double</span>[<span class="number">2</span> * l];</div><div class="line">    <span class="keyword">double</span> *linear_term = <span class="keyword">new</span> <span class="keyword">double</span>[<span class="number">2</span> * l];</div><div class="line">    schar *y = <span class="keyword">new</span> schar[<span class="number">2</span> * l];    <span class="comment">//新定义了y值，对应Solver的y</span></div><div class="line">    <span class="keyword">int</span> i;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;l; i++)</div><div class="line">    &#123;</div><div class="line">        alpha2[i] = <span class="number">0</span>;</div><div class="line">        linear_term[i] = param-&gt;p - prob-&gt;y[i];    <span class="comment">//epsilon*e-z,epsilon为间隔带，e为全为1的行向量，z为样本数据的目标值</span></div><div class="line">        y[i] = <span class="number">1</span>;</div><div class="line"></div><div class="line">        alpha2[i + l] = <span class="number">0</span>;</div><div class="line">        linear_term[i + l] = param-&gt;p + prob-&gt;y[i];    <span class="comment">//epsilon*e+z</span></div><div class="line">        y[i + l] = <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Solver s;</div><div class="line">    s.Solve(<span class="number">2</span> * l, SVR_Q(*prob, *param), linear_term, y,</div><div class="line">        alpha2, param-&gt;C, param-&gt;C, param-&gt;eps, si, param-&gt;shrinking);</div><div class="line"></div><div class="line">    <span class="keyword">double</span> sum_alpha = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;l; i++)</div><div class="line">    &#123;</div><div class="line">        alpha[i] = alpha2[i] - alpha2[i + l];    <span class="comment">//将alpha[i]-alpha[i+1]得到数据样本x前的最终系数</span></div><div class="line">        sum_alpha += <span class="built_in">fabs</span>(alpha[i]);</div><div class="line">    &#125;</div><div class="line">    info(<span class="string">"nu = %f\n"</span>, sum_alpha / (param-&gt;C*l));</div><div class="line"></div><div class="line">    <span class="keyword">delete</span>[] alpha2;</div><div class="line">    <span class="keyword">delete</span>[] linear_term;</div><div class="line">    <span class="keyword">delete</span>[] y;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="static-decision-function-svm-train-one-const-svm-problem-prob-const-svm-parameter-param-double-Cp-double-Cn"><a href="#static-decision-function-svm-train-one-const-svm-problem-prob-const-svm-parameter-param-double-Cp-double-Cn" class="headerlink" title="static decision_function svm_train_one(const svm_problem *prob, const svm_parameter *param, double Cp, double Cn)"></a>static decision_function svm_train_one(const svm_problem *prob, const svm_parameter *param, double Cp, double Cn)</h2><p>根据kernel_type的不同调用不同的求解函数，并计算支持向量的个数与处于边界的支持向量个数。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> decision_function <span class="title">svm_train_one</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params">    <span class="keyword">const</span> svm_problem *prob, <span class="keyword">const</span> svm_parameter *param,</span></span></div><div class="line"><span class="function"><span class="params">    <span class="keyword">double</span> Cp, <span class="keyword">double</span> Cn)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">double</span> *alpha = Malloc(<span class="keyword">double</span>, prob-&gt;l);</div><div class="line">    Solver::SolutionInfo si;</div><div class="line">    <span class="keyword">switch</span> (param-&gt;svm_type)</div><div class="line">    &#123;</div><div class="line">    <span class="keyword">case</span> C_SVC:</div><div class="line">        solve_c_svc(prob, param, alpha, &amp;si, Cp, Cn);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> NU_SVC:</div><div class="line">        solve_nu_svc(prob, param, alpha, &amp;si);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> ONE_CLASS:</div><div class="line">        solve_one_class(prob, param, alpha, &amp;si);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> EPSILON_SVR:</div><div class="line">        solve_epsilon_svr(prob, param, alpha, &amp;si);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> NU_SVR:</div><div class="line">        solve_nu_svr(prob, param, alpha, &amp;si);</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    info(<span class="string">"obj = %f, rho = %f\n"</span>, si.obj, si.rho);</div><div class="line"></div><div class="line">    <span class="comment">// output SVs</span></div><div class="line"></div><div class="line">    <span class="keyword">int</span> nSV = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> nBSV = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i&lt;prob-&gt;l; i++)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">if</span> (<span class="built_in">fabs</span>(alpha[i]) &gt; <span class="number">0</span>)</div><div class="line">        &#123;</div><div class="line">            ++nSV;</div><div class="line">            <span class="keyword">if</span> (prob-&gt;y[i] &gt; <span class="number">0</span>)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span> (<span class="built_in">fabs</span>(alpha[i]) &gt;= si.upper_bound_p)</div><div class="line">                    ++nBSV;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">else</span></div><div class="line">            &#123;</div><div class="line">                <span class="keyword">if</span> (<span class="built_in">fabs</span>(alpha[i]) &gt;= si.upper_bound_n)</div><div class="line">                    ++nBSV;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    info(<span class="string">"nSV = %d, nBSV = %d\n"</span>, nSV, nBSV);</div><div class="line"></div><div class="line">    decision_function f;</div><div class="line">    f.alpha = alpha;</div><div class="line">    f.rho = si.rho;</div><div class="line">    <span class="keyword">return</span> f;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="svm-model-svm-train-const-svm-problem-prob-const-svm-parameter-param-；"><a href="#svm-model-svm-train-const-svm-problem-prob-const-svm-parameter-param-；" class="headerlink" title="svm_model *svm_train(const svm_problem *prob, const svm_parameter *param)；"></a>svm_model *svm_train(const svm_problem *prob, const svm_parameter *param)；</h2><p>根据不同svm_type开辟不同空间，最后返回训练好的svm model。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div></pre></td><td class="code"><pre><div class="line"><span class="function">svm_model *<span class="title">svm_train</span><span class="params">(<span class="keyword">const</span> svm_problem *prob, <span class="keyword">const</span> svm_parameter *param)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    svm_model *model = Malloc(svm_model, <span class="number">1</span>);</div><div class="line">    model-&gt;param = *param;</div><div class="line">    model-&gt;free_sv = <span class="number">0</span>; <span class="comment">// XXX</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> (param-&gt;svm_type == ONE_CLASS ||</div><div class="line">        param-&gt;svm_type == EPSILON_SVR ||</div><div class="line">        param-&gt;svm_type == NU_SVR)</div><div class="line">    &#123;</div><div class="line">        <span class="comment">// regression or one-class-svm</span></div><div class="line">        model-&gt;nr_class = <span class="number">2</span>;</div><div class="line">        model-&gt;label = <span class="literal">NULL</span>;</div><div class="line">        model-&gt;nSV = <span class="literal">NULL</span>;</div><div class="line">        model-&gt;probA = <span class="literal">NULL</span>; model-&gt;probB = <span class="literal">NULL</span>;</div><div class="line">        model-&gt;sv_coef = Malloc(<span class="keyword">double</span> *, <span class="number">1</span>);</div><div class="line"></div><div class="line">        <span class="comment">/*if (param-&gt;probability &amp;&amp;</span></div><div class="line"><span class="comment">            (param-&gt;svm_type == EPSILON_SVR ||</span></div><div class="line"><span class="comment">                param-&gt;svm_type == NU_SVR))</span></div><div class="line"><span class="comment">        &#123;</span></div><div class="line"><span class="comment">            model-&gt;probA = Malloc(double, 1);</span></div><div class="line"><span class="comment">            model-&gt;probA[0] = svm_svr_probability(prob, param);</span></div><div class="line"><span class="comment">        &#125;*/</span></div><div class="line"></div><div class="line">        decision_function f = svm_train_one(prob, param, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">        model-&gt;rho = Malloc(<span class="keyword">double</span>, <span class="number">1</span>);</div><div class="line">        model-&gt;rho[<span class="number">0</span>] = f.rho;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> nSV = <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> i;</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;prob-&gt;l; i++)</div><div class="line">            <span class="keyword">if</span> (<span class="built_in">fabs</span>(f.alpha[i]) &gt; <span class="number">0</span>) ++nSV;</div><div class="line">        model-&gt;l = nSV;</div><div class="line">        model-&gt;SV = Malloc(svm_node *, nSV);</div><div class="line">        model-&gt;sv_coef[<span class="number">0</span>] = Malloc(<span class="keyword">double</span>, nSV);</div><div class="line">        model-&gt;sv_indices = Malloc(<span class="keyword">int</span>, nSV);</div><div class="line">        <span class="keyword">int</span> j = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;prob-&gt;l; i++)</div><div class="line">            <span class="keyword">if</span> (<span class="built_in">fabs</span>(f.alpha[i]) &gt; <span class="number">0</span>)</div><div class="line">            &#123;</div><div class="line">                model-&gt;SV[j] = prob-&gt;x[i];</div><div class="line">                model-&gt;sv_coef[<span class="number">0</span>][j] = f.alpha[i];</div><div class="line">                model-&gt;sv_indices[j] = i + <span class="number">1</span>;</div><div class="line">                ++j;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        <span class="built_in">free</span>(f.alpha);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        <span class="comment">// classification</span></div><div class="line">        <span class="keyword">int</span> l = prob-&gt;l;</div><div class="line">        <span class="keyword">int</span> nr_class;</div><div class="line">        <span class="keyword">int</span> *label = <span class="literal">NULL</span>;</div><div class="line">        <span class="keyword">int</span> *start = <span class="literal">NULL</span>;</div><div class="line">        <span class="keyword">int</span> *count = <span class="literal">NULL</span>;</div><div class="line">        <span class="keyword">int</span> *perm = Malloc(<span class="keyword">int</span>, l);</div><div class="line"></div><div class="line">        <span class="comment">// group training data of the same class</span></div><div class="line">        svm_group_classes(prob, &amp;nr_class, &amp;label, &amp;start, &amp;count, perm);</div><div class="line">        <span class="keyword">if</span> (nr_class == <span class="number">1</span>)</div><div class="line">            info(<span class="string">"WARNING: training data in only one class. See README for details.\n"</span>);</div><div class="line"></div><div class="line">        svm_node **x = Malloc(svm_node *, l);</div><div class="line">        <span class="keyword">int</span> i;</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;l; i++)</div><div class="line">            x[i] = prob-&gt;x[perm[i]];</div><div class="line"></div><div class="line">        <span class="comment">// calculate weighted C</span></div><div class="line"></div><div class="line">        <span class="keyword">double</span> *weighted_C = Malloc(<span class="keyword">double</span>, nr_class);</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;nr_class; i++)</div><div class="line">            weighted_C[i] = param-&gt;C;</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;param-&gt;nr_weight; i++)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">int</span> j;</div><div class="line">            <span class="keyword">for</span> (j = <span class="number">0</span>; j&lt;nr_class; j++)</div><div class="line">                <span class="keyword">if</span> (param-&gt;weight_label[i] == label[j])</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">if</span> (j == nr_class)</div><div class="line">                <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"WARNING: class label %d specified in weight is not found\n"</span>, param-&gt;weight_label[i]);</div><div class="line">            <span class="keyword">else</span></div><div class="line">                weighted_C[j] *= param-&gt;weight[i];</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// train k*(k-1)/2 models</span></div><div class="line"></div><div class="line">        <span class="keyword">bool</span> *nonzero = Malloc(<span class="keyword">bool</span>, l);</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;l; i++)</div><div class="line">            nonzero[i] = <span class="literal">false</span>;</div><div class="line">        decision_function *f = Malloc(decision_function, nr_class*(nr_class - <span class="number">1</span>) / <span class="number">2</span>);</div><div class="line"></div><div class="line">        <span class="keyword">double</span> *probA = <span class="literal">NULL</span>, *probB = <span class="literal">NULL</span>;</div><div class="line">        <span class="keyword">if</span> (param-&gt;probability)</div><div class="line">        &#123;</div><div class="line">            probA = Malloc(<span class="keyword">double</span>, nr_class*(nr_class - <span class="number">1</span>) / <span class="number">2</span>);</div><div class="line">            probB = Malloc(<span class="keyword">double</span>, nr_class*(nr_class - <span class="number">1</span>) / <span class="number">2</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> p = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;nr_class; i++)</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = i + <span class="number">1</span>; j&lt;nr_class; j++)</div><div class="line">            &#123;</div><div class="line">                svm_problem sub_prob;</div><div class="line">                <span class="keyword">int</span> si = start[i], sj = start[j];</div><div class="line">                <span class="keyword">int</span> ci = count[i], cj = count[j];</div><div class="line">                sub_prob.l = ci + cj;</div><div class="line">                sub_prob.x = Malloc(svm_node *, sub_prob.l);</div><div class="line">                sub_prob.y = Malloc(<span class="keyword">double</span>, sub_prob.l);</div><div class="line">                <span class="keyword">int</span> k;</div><div class="line">                <span class="keyword">for</span> (k = <span class="number">0</span>; k&lt;ci; k++)</div><div class="line">                &#123;</div><div class="line">                    sub_prob.x[k] = x[si + k];</div><div class="line">                    sub_prob.y[k] = +<span class="number">1</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">for</span> (k = <span class="number">0</span>; k&lt;cj; k++)</div><div class="line">                &#123;</div><div class="line">                    sub_prob.x[ci + k] = x[sj + k];</div><div class="line">                    sub_prob.y[ci + k] = <span class="number">-1</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (param-&gt;probability)</div><div class="line">                    svm_binary_svc_probability(&amp;sub_prob, param, weighted_C[i], weighted_C[j], probA[p], probB[p]);</div><div class="line"></div><div class="line">                f[p] = svm_train_one(&amp;sub_prob, param, weighted_C[i], weighted_C[j]);</div><div class="line">                <span class="keyword">for</span> (k = <span class="number">0</span>; k&lt;ci; k++)</div><div class="line">                    <span class="keyword">if</span> (!nonzero[si + k] &amp;&amp; <span class="built_in">fabs</span>(f[p].alpha[k]) &gt; <span class="number">0</span>)</div><div class="line">                        nonzero[si + k] = <span class="literal">true</span>;</div><div class="line">                <span class="keyword">for</span> (k = <span class="number">0</span>; k&lt;cj; k++)</div><div class="line">                    <span class="keyword">if</span> (!nonzero[sj + k] &amp;&amp; <span class="built_in">fabs</span>(f[p].alpha[ci + k]) &gt; <span class="number">0</span>)</div><div class="line">                        nonzero[sj + k] = <span class="literal">true</span>;</div><div class="line">                <span class="built_in">free</span>(sub_prob.x);</div><div class="line">                <span class="built_in">free</span>(sub_prob.y);</div><div class="line">                ++p;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        <span class="comment">// build output</span></div><div class="line"></div><div class="line">        model-&gt;nr_class = nr_class;</div><div class="line"></div><div class="line">        model-&gt;label = Malloc(<span class="keyword">int</span>, nr_class);</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;nr_class; i++)</div><div class="line">            model-&gt;label[i] = label[i];</div><div class="line"></div><div class="line">        model-&gt;rho = Malloc(<span class="keyword">double</span>, nr_class*(nr_class - <span class="number">1</span>) / <span class="number">2</span>);</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;nr_class*(nr_class - <span class="number">1</span>) / <span class="number">2</span>; i++)</div><div class="line">            model-&gt;rho[i] = f[i].rho;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (param-&gt;probability)</div><div class="line">        &#123;</div><div class="line">            model-&gt;probA = Malloc(<span class="keyword">double</span>, nr_class*(nr_class - <span class="number">1</span>) / <span class="number">2</span>);</div><div class="line">            model-&gt;probB = Malloc(<span class="keyword">double</span>, nr_class*(nr_class - <span class="number">1</span>) / <span class="number">2</span>);</div><div class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;nr_class*(nr_class - <span class="number">1</span>) / <span class="number">2</span>; i++)</div><div class="line">            &#123;</div><div class="line">                model-&gt;probA[i] = probA[i];</div><div class="line">                model-&gt;probB[i] = probB[i];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">        &#123;</div><div class="line">            model-&gt;probA = <span class="literal">NULL</span>;</div><div class="line">            model-&gt;probB = <span class="literal">NULL</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> total_sv = <span class="number">0</span>;</div><div class="line">        <span class="keyword">int</span> *nz_count = Malloc(<span class="keyword">int</span>, nr_class);</div><div class="line">        model-&gt;nSV = Malloc(<span class="keyword">int</span>, nr_class);</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;nr_class; i++)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">int</span> nSV = <span class="number">0</span>;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j&lt;count[i]; j++)</div><div class="line">                <span class="keyword">if</span> (nonzero[start[i] + j])</div><div class="line">                &#123;</div><div class="line">                    ++nSV;</div><div class="line">                    ++total_sv;</div><div class="line">                &#125;</div><div class="line">            model-&gt;nSV[i] = nSV;</div><div class="line">            nz_count[i] = nSV;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        info(<span class="string">"Total nSV = %d\n"</span>, total_sv);</div><div class="line"></div><div class="line">        model-&gt;l = total_sv;</div><div class="line">        model-&gt;SV = Malloc(svm_node *, total_sv);</div><div class="line">        model-&gt;sv_indices = Malloc(<span class="keyword">int</span>, total_sv);</div><div class="line">        p = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;l; i++)</div><div class="line">            <span class="keyword">if</span> (nonzero[i])</div><div class="line">            &#123;</div><div class="line">                model-&gt;SV[p] = x[i];</div><div class="line">                model-&gt;sv_indices[p++] = perm[i] + <span class="number">1</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> *nz_start = Malloc(<span class="keyword">int</span>, nr_class);</div><div class="line">        nz_start[<span class="number">0</span>] = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">1</span>; i&lt;nr_class; i++)</div><div class="line">            nz_start[i] = nz_start[i - <span class="number">1</span>] + nz_count[i - <span class="number">1</span>];</div><div class="line"></div><div class="line">        model-&gt;sv_coef = Malloc(<span class="keyword">double</span> *, nr_class - <span class="number">1</span>);</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;nr_class - <span class="number">1</span>; i++)</div><div class="line">            model-&gt;sv_coef[i] = Malloc(<span class="keyword">double</span>, total_sv);</div><div class="line"></div><div class="line">        p = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;nr_class; i++)</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = i + <span class="number">1</span>; j&lt;nr_class; j++)</div><div class="line">            &#123;</div><div class="line">                <span class="comment">// classifier (i,j): coefficients with</span></div><div class="line">                <span class="comment">// i are in sv_coef[j-1][nz_start[i]...],</span></div><div class="line">                <span class="comment">// j are in sv_coef[i][nz_start[j]...]</span></div><div class="line"></div><div class="line">                <span class="keyword">int</span> si = start[i];</div><div class="line">                <span class="keyword">int</span> sj = start[j];</div><div class="line">                <span class="keyword">int</span> ci = count[i];</div><div class="line">                <span class="keyword">int</span> cj = count[j];</div><div class="line"></div><div class="line">                <span class="keyword">int</span> q = nz_start[i];</div><div class="line">                <span class="keyword">int</span> k;</div><div class="line">                <span class="keyword">for</span> (k = <span class="number">0</span>; k&lt;ci; k++)</div><div class="line">                    <span class="keyword">if</span> (nonzero[si + k])</div><div class="line">                        model-&gt;sv_coef[j - <span class="number">1</span>][q++] = f[p].alpha[k];</div><div class="line">                q = nz_start[j];</div><div class="line">                <span class="keyword">for</span> (k = <span class="number">0</span>; k&lt;cj; k++)</div><div class="line">                    <span class="keyword">if</span> (nonzero[sj + k])</div><div class="line">                        model-&gt;sv_coef[i][q++] = f[p].alpha[ci + k];</div><div class="line">                ++p;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        <span class="built_in">free</span>(label);</div><div class="line">        <span class="built_in">free</span>(probA);</div><div class="line">        <span class="built_in">free</span>(probB);</div><div class="line">        <span class="built_in">free</span>(count);</div><div class="line">        <span class="built_in">free</span>(perm);</div><div class="line">        <span class="built_in">free</span>(start);</div><div class="line">        <span class="built_in">free</span>(x);</div><div class="line">        <span class="built_in">free</span>(weighted_C);</div><div class="line">        <span class="built_in">free</span>(nonzero);</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;nr_class*(nr_class - <span class="number">1</span>) / <span class="number">2</span>; i++)</div><div class="line">            <span class="built_in">free</span>(f[i].alpha);</div><div class="line">        <span class="built_in">free</span>(f);</div><div class="line">        <span class="built_in">free</span>(nz_count);</div><div class="line">        <span class="built_in">free</span>(nz_start);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> model;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="double-svm-predict-values-const-svm-model-model-const-svm-node-x-double-dec-values"><a href="#double-svm-predict-values-const-svm-model-model-const-svm-node-x-double-dec-values" class="headerlink" title="double svm_predict_values(const svm_model *model, const svm_node *x, double* dec_values)"></a>double svm_predict_values(const svm_model *model, const svm_node *x, double* dec_values)</h2><p>该函数用于预测单个测试样本数据，因此对于一组测试样本需要调用n次。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">double</span> <span class="title">svm_predict_values</span><span class="params">(<span class="keyword">const</span> svm_model *model, <span class="keyword">const</span> svm_node *x, <span class="keyword">double</span>* dec_values)</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">int</span> i;</div><div class="line">    <span class="keyword">if</span> (model-&gt;param.svm_type == ONE_CLASS ||</div><div class="line">        model-&gt;param.svm_type == EPSILON_SVR ||</div><div class="line">        model-&gt;param.svm_type == NU_SVR)</div><div class="line">    &#123;</div><div class="line">        <span class="keyword">double</span> *sv_coef = model-&gt;sv_coef[<span class="number">0</span>];</div><div class="line">        <span class="keyword">double</span> sum = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;model-&gt;l; i++)</div><div class="line">            sum += sv_coef[i] * Kernel::k_function(x, model-&gt;SV[i], model-&gt;param);    <span class="comment">//对应决策公式的前半部分，即αi*K(xi,x)</span></div><div class="line">        sum -= model-&gt;rho[<span class="number">0</span>];    <span class="comment">//加上决策函数的常数项</span></div><div class="line">        *dec_values = sum;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (model-&gt;param.svm_type == ONE_CLASS)</div><div class="line">            <span class="keyword">return</span> (sum&gt;<span class="number">0</span>) ? <span class="number">1</span> : <span class="number">-1</span>;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            <span class="keyword">return</span> sum;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        <span class="keyword">int</span> nr_class = model-&gt;nr_class;</div><div class="line">        <span class="keyword">int</span> l = model-&gt;l;</div><div class="line"></div><div class="line">        <span class="keyword">double</span> *kvalue = Malloc(<span class="keyword">double</span>, l);</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;l; i++)</div><div class="line">            kvalue[i] = Kernel::k_function(x, model-&gt;SV[i], model-&gt;param);</div><div class="line"></div><div class="line">        <span class="keyword">int</span> *start = Malloc(<span class="keyword">int</span>, nr_class);</div><div class="line">        start[<span class="number">0</span>] = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">1</span>; i&lt;nr_class; i++)</div><div class="line">            start[i] = start[i - <span class="number">1</span>] + model-&gt;nSV[i - <span class="number">1</span>];</div><div class="line"></div><div class="line">        <span class="keyword">int</span> *vote = Malloc(<span class="keyword">int</span>, nr_class);</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;nr_class; i++)</div><div class="line">            vote[i] = <span class="number">0</span>;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> p = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;nr_class; i++)</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = i + <span class="number">1</span>; j&lt;nr_class; j++)</div><div class="line">            &#123;</div><div class="line">                <span class="keyword">double</span> sum = <span class="number">0</span>;</div><div class="line">                <span class="keyword">int</span> si = start[i];</div><div class="line">                <span class="keyword">int</span> sj = start[j];</div><div class="line">                <span class="keyword">int</span> ci = model-&gt;nSV[i];</div><div class="line">                <span class="keyword">int</span> cj = model-&gt;nSV[j];</div><div class="line"></div><div class="line">                <span class="keyword">int</span> k;</div><div class="line">                <span class="keyword">double</span> *coef1 = model-&gt;sv_coef[j - <span class="number">1</span>];</div><div class="line">                <span class="keyword">double</span> *coef2 = model-&gt;sv_coef[i];</div><div class="line">                <span class="keyword">for</span> (k = <span class="number">0</span>; k&lt;ci; k++)</div><div class="line">                    sum += coef1[si + k] * kvalue[si + k];</div><div class="line">                <span class="keyword">for</span> (k = <span class="number">0</span>; k&lt;cj; k++)</div><div class="line">                    sum += coef2[sj + k] * kvalue[sj + k];</div><div class="line">                sum -= model-&gt;rho[p];</div><div class="line">                dec_values[p] = sum;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (dec_values[p] &gt; <span class="number">0</span>)</div><div class="line">                    ++vote[i];</div><div class="line">                <span class="keyword">else</span></div><div class="line">                    ++vote[j];</div><div class="line">                p++;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> vote_max_idx = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (i = <span class="number">1</span>; i&lt;nr_class; i++)</div><div class="line">            <span class="keyword">if</span> (vote[i] &gt; vote[vote_max_idx])</div><div class="line">                vote_max_idx = i;</div><div class="line"></div><div class="line">        <span class="built_in">free</span>(kvalue);</div><div class="line">        <span class="built_in">free</span>(start);</div><div class="line">        <span class="built_in">free</span>(vote);</div><div class="line">        <span class="keyword">return</span> model-&gt;label[vote_max_idx];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference:"></a>Reference:</h1><p>[1] Smola A J, Schölkopf B. A tutorial on support vector regression[J]. Statistics &amp; Computing, 2004, volume 14(3):199-222(24).<br>[2] Chang C C, Lin C J. LIBSVM: A library for support vector machines[M]. ACM, 2011.<br>[3] Fan R E, Chen P H, Lin C J, et al. Working Set Selection Using Second Order Information for Training Support Vector Machines[J]. Journal of Machine Learning Research, 2005, 6(4):1889-1918.<br>[4] Svm O F. Sequential Minimal Optimization for SVM[J]. 2007.<br>[5] LibSVM中select_working_set函数：<a href="http://blog.csdn.net/le_zhou/article/details/40505465" target="_blank" rel="external">http://blog.csdn.net/le_zhou/article/details/40505465</a><br>[6] libsvm最新源代码（版本3.21）理解解析（三）：<a href="http://blog.csdn.net/xiaoqiangqiangjie/article/details/53886907" target="_blank" rel="external">http://blog.csdn.net/xiaoqiangqiangjie/article/details/53886907</a><br>[7] LibSVM源码剖析（java版）：<a href="http://makaidong.com/bentuwuying/21760_40631.html" target="_blank" rel="external">http://makaidong.com/bentuwuying/21760_40631.html</a><br>[8] LibSVM-2.6 程序代码注释,上交</p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>Donate comment here</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/wechatpay.jpg" alt="Yunkun Xu WeChat Pay"/>
        <p>WeChat Pay</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/alipay.jpg" alt="Yunkun Xu Alipay"/>
        <p>Alipay</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Machine-learning/" rel="tag"># Machine learning</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/09/13/P问题、NP问题、NPC问题、NP-hard问题详解/" rel="next" title="P问题、NP问题、NPC问题、NP-hard问题详解">
                <i class="fa fa-chevron-left"></i> P问题、NP问题、NPC问题、NP-hard问题详解
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/08/11/Hexo+GitHub搭建私人博客/" rel="prev" title="Hexo+GitHub搭建私人博客">
                Hexo+GitHub搭建私人博客 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="lv-container" data-id="city" data-uid="MTAyMC8zMDg2NC83NDEz"></div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          
            <img class="site-author-image" itemprop="image"
              src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1505221430290&amp;di=5d6a88d013890d4f520618b024b4aaed&amp;imgtype=0&amp;src=http%3A%2F%2Fimg3.duitang.com%2Fuploads%2Fitem%2F201601%2F03%2F20160103085338_eyBCL.jpeg"
              alt="Yunkun Xu" />
          
            <p class="site-author-name" itemprop="name">Yunkun Xu</p>
            <p class="site-description motion-element" itemprop="description"></p>
        </div>

        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
            
              <a href="/archives/">
            
                <span class="site-state-item-count">6</span>
                <span class="site-state-item-name">posts</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">22</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#LibSVM整体流程"><span class="nav-number">1.</span> <span class="nav-text">LibSVM整体流程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#train："><span class="nav-number">1.1.</span> <span class="nav-text">train：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#predict"><span class="nav-number">1.2.</span> <span class="nav-text">predict</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#svm-h文件解析"><span class="nav-number">2.</span> <span class="nav-text">svm.h文件解析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#svm-node"><span class="nav-number">2.1.</span> <span class="nav-text">svm_node</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#svm-problem"><span class="nav-number">2.2.</span> <span class="nav-text">svm_problem</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#svm-parameter"><span class="nav-number">2.3.</span> <span class="nav-text">svm_parameter</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#svm-model"><span class="nav-number">2.4.</span> <span class="nav-text">svm_model</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#svm-cpp文件解析"><span class="nav-number">3.</span> <span class="nav-text">svm.cpp文件解析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Kernel类"><span class="nav-number">3.1.</span> <span class="nav-text">Kernel类</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#成员变量"><span class="nav-number">3.1.1.</span> <span class="nav-text">成员变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#成员函数"><span class="nav-number">3.1.2.</span> <span class="nav-text">成员函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Kernel-int-l-svm-node-const-x-const-svm-parameter-amp-param"><span class="nav-number">3.1.2.1.</span> <span class="nav-text">Kernel(int l, svm_node * const * x, const svm_parameter& param);</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#static-double-dot-const-svm-node-px-const-svm-node-py"><span class="nav-number">3.1.2.2.</span> <span class="nav-text">static double dot(const svm_node *px, const svm_node *py);</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#static-double-k-function-const-svm-node-x-const-svm-node-y-const-svm-parameter-amp-param"><span class="nav-number">3.1.2.3.</span> <span class="nav-text">static double k_function(const svm_node *x, const svm_node *y, const svm_parameter& param);</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#virtual-Qfloat-get-Q-int-column-int-len"><span class="nav-number">3.1.2.4.</span> <span class="nav-text">virtual Qfloat *get_Q(int column, int len);</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#virtual-void-swap-index-int-i-int-j"><span class="nav-number">3.1.2.5.</span> <span class="nav-text">virtual void swap_index(int i, int j);</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#virtual-double-get-QD"><span class="nav-number">3.1.2.6.</span> <span class="nav-text">virtual double *get_QD();</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#double-Kernel-kernel-function-int-i-int-j-；"><span class="nav-number">3.1.2.7.</span> <span class="nav-text">double (Kernel::*kernel_function)(int i, int j)；</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Solver类"><span class="nav-number">3.2.</span> <span class="nav-text">Solver类</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#成员变量-1"><span class="nav-number">3.2.1.</span> <span class="nav-text">成员变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#成员函数-1"><span class="nav-number">3.2.2.</span> <span class="nav-text">成员函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#double-get-C-int-i-；"><span class="nav-number">3.2.2.1.</span> <span class="nav-text">double get_C(int i)；</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#void-swap-index-int-i-int-j"><span class="nav-number">3.2.2.2.</span> <span class="nav-text">void swap_index(int i, int j);</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#void-reconstruct-gradient"><span class="nav-number">3.2.2.3.</span> <span class="nav-text">void reconstruct_gradient();</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#virtual-void-do-shrinking"><span class="nav-number">3.2.2.4.</span> <span class="nav-text">virtual void do_shrinking();</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#virtual-int-select-working-set-int-amp-i-int-amp-j"><span class="nav-number">3.2.2.5.</span> <span class="nav-text">virtual int select_working_set(int &i, int &j);</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#选择i"><span class="nav-number">3.2.2.5.1.</span> <span class="nav-text">选择i</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#选择j"><span class="nav-number">3.2.2.5.2.</span> <span class="nav-text">选择j</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#void-Solve-int-l-const-QMatrix-amp-Q-const-double-p-const-schar-y-double-alpha-double-Cp-double-Cn-double-eps-SolutionInfo-si-int-shrinking"><span class="nav-number">3.2.2.6.</span> <span class="nav-text">void Solve(int l, const QMatrix& Q, const double *p_, const schar *y_, double *alpha_, double Cp, double Cn, double eps, SolutionInfo* si, int shrinking);</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#virtual-double-calculate-rho"><span class="nav-number">3.2.2.7.</span> <span class="nav-text">virtual double calculate_rho();</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SVR-Q类"><span class="nav-number">3.3.</span> <span class="nav-text">SVR_Q类</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#成员变量-2"><span class="nav-number">3.3.1.</span> <span class="nav-text">成员变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#成员函数-2"><span class="nav-number">3.3.2.</span> <span class="nav-text">成员函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SVR-Q-const-svm-problem-amp-prob-const-svm-parameter-amp-param-Kernel-prob-l-prob-x-param"><span class="nav-number">3.3.2.1.</span> <span class="nav-text">SVR_Q(const svm_problem& prob, const svm_parameter& param):Kernel(prob.l, prob.x, param);</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Qfloat-get-Q-int-i-int-len-const"><span class="nav-number">3.3.2.2.</span> <span class="nav-text">Qfloat *get_Q(int i, int len) const;</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#static-void-solve-epsilon-svr-const-svm-problem-prob-const-svm-parameter-param-double-alpha-Solver-SolutionInfo-si"><span class="nav-number">3.4.</span> <span class="nav-text">static void solve_epsilon_svr(const svm_problem *prob, const svm_parameter *param, double *alpha, Solver::SolutionInfo* si)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#static-decision-function-svm-train-one-const-svm-problem-prob-const-svm-parameter-param-double-Cp-double-Cn"><span class="nav-number">3.5.</span> <span class="nav-text">static decision_function svm_train_one(const svm_problem *prob, const svm_parameter *param, double Cp, double Cn)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#svm-model-svm-train-const-svm-problem-prob-const-svm-parameter-param-；"><span class="nav-number">3.6.</span> <span class="nav-text">svm_model *svm_train(const svm_problem *prob, const svm_parameter *param)；</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#double-svm-predict-values-const-svm-model-model-const-svm-node-x-double-dec-values"><span class="nav-number">3.7.</span> <span class="nav-text">double svm_predict_values(const svm_model *model, const svm_node *x, double* dec_values)</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Reference"><span class="nav-number">4.</span> <span class="nav-text">Reference:</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>

<div class="powered-by">
 | 
<i class="fa fa-bullseye"></i><span id="busuanzi_container_site_pv">
  本站总访问量<span id="busuanzi_value_site_pv"></span>次
</span>
</div>

<div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yunkun Xu</span>

  
</div>





        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  

  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>


  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  








  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("QhaBjkfW4URLRbhgJHxDwlLS-gzGzoHsz", "lMWD4RO6uM9qzr8tTOVVb70w");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  


  

  

  
  
</body>
</html>

<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/love.js"></script>